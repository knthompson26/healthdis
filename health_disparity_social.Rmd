---
title: "Health disparity framework: Can social connection mitigate risk for depression" 
author: "Katherine N Thompson"
date: "2024-11-04"
output:  
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: flatly
    code_folding: show
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = 'markup')
options(bitmapType = 'quartz')
```

```{r clear global environment, include=FALSE}
remove(list = ls())
```

```{r set seed, include=FALSE}
set.seed(123)
```

```{r Load packages, include=FALSE}
library(knitr)
library(purrr)
library(rlang)
library(haven)
library(psych) 
library(tidyr)
library(lavaan)
library(ggplot2)
library(broom)
library(questionr) 
library(readr)
library(mice)
library(nnet)
library(MASS)
library(boot)
library(tidyverse)
library(dplyr)
library(Cairo)
library(viridis)
library(patchwork)
```

# README

The overall aim of this study is to understand the extent to which an intervention on social connection in childhood can mitigate the association between vulnerable characteristics and depression in adulthood. Using the health disparity framework, we will test mediation models between vulnerable characteristics (genetic vulnerability, socioeconomic position, sex, and race), social connection, and depression symptoms.

Our research questions are as follows:

1. How much of the disparity in depression symptoms (Y) between polygenic risk (X=0,1,2,3,4) quintiles would remain, if we were to intervene on inclusion, community, social connection, and friendship (M) so that those with the highest genetic risk receive the same support and inclusion as those with the lowest genetic risk (M(X=0)).
2. How much of the disparity in depression symptoms (Y) between males (X=0) and females (X=1) would remain, if we were to intervene on inclusion, community, social connection, and friendship (M) so that women receive the same support and inclusion as men (M(X=0)).
3. How much of the disparity in depression symptoms (Y) would remain both between White (X=0) and Black (X=1) people and White (X=0) and Asian (X=1) people, if we were to intervene on inclusion, community, social connection, and friendship (M) so that Black or Asian people receive the same support and inclusion as White people (M(X=0)).
4. How much of the disparity in depression symptoms (Y) between people from low (X=0) and high (X=1) socioeconomic position families would remain, if we were to intervene on inclusion, community, social connection, and friendship (M) so that low socioeconomic position families receive the same support and inclusion as high socioeconomic position (M(X=0)).

We adapt code from Herle et al. (2023), which applies a health disparity framework to evaluate whether an intervention on physical activity could mitigate the association between genetic liability for obesity (measured using a BMI polygenic score) and childhood/adolescent BMI.

Data preparation is done within the script *health_disparity_dataprep.Rmd*

There is a section for each of the risk characteristics - 

# Read in clean data

```{r read clean pheno data for W2 and W4}
dat_pheno_W2 <- readRDS("/project/rche/data/datasets/addhealth/scratch/kthompson/healthdis/dat_W2pheno_imp_full.rds")
dat_pheno_W4 <- readRDS("/project/rche/data/datasets/addhealth/scratch/kthompson/healthdis/dat_W4pheno_imp_full.rds")
```

# Functions

```{r functions}
# replace ggsave 
save_gg_cairo <- function(plot, filename, width = 900, height = 800) {
  library(Cairo)
  CairoPNG(filename, width = width, height = height)
  print(plot)
  if (!is.null(dev.list())) dev.off()
}

# standardize IID across datasets
convert_iid_to_char <- function(df) {
  df %>% mutate(IID = as.character(IID))
}
```

# Recoding

We recode the following:

* BIO_SEX so that males (X=0) and females (X=1). For BIO_SEX: 1 = Male, 2 = Female
* H1GI1Y - 96 to be NA 
* Squared continuous variables
* Create random normal distributions for X and Y - we simulate standard normal error and create this as a new variable (UM and UY). 

```{r recode inputs}
recode_inputs <- function(dat) {
  dat %>%
    dplyr::mutate(
      sex = case_when(BIO_SEX == 1 ~ 0, BIO_SEX == 2 ~ 1),
      H1GI1Y = na_if(H1GI1Y, 96),
      family2 = family^2,
      school2 = school^2,
      friends2 = friends^2,
      neigh2 = neigh^2,
      religion2 = religion^2,
      social2 = social^2,
      UM = rnorm(n()),
      UY = rnorm(n())
    ) %>%
    dplyr::select(-BIO_SEX)
}

# apply to both waves
dat_pheno_W2 <- recode_inputs(dat_pheno_W2)
dat_pheno_W4 <- recode_inputs(dat_pheno_W4)
```

Dummy code race so each category is compared to white:

1 = White
2 = Black
3 = Native American
4 = Asian

```{r dummy code race}
# Wave 2
dat_pheno_W2 <- dat_pheno_W2 %>%
  mutate(
    black = 
      case_when(
        RACE1 == 2 ~ 1,   # black coded as 1
        RACE1 == 1 ~ 0,   # white coded as 0
        TRUE ~ NA_real_   # all other races coded as NA
      ),
    natam =
      case_when(
        RACE1 == 3 ~ 1,   # native american coded as 1
        RACE1 == 1 ~ 0,   # white coded as 0
        TRUE ~ NA_real_   # all other races coded as NA
      ),
    asian =
      case_when(
        RACE1 == 4 ~ 1,   # native american coded as 1
        RACE1 == 1 ~ 0,   # white coded as 0
        TRUE ~ NA_real_   # all other races coded as NA
      )
  )

# Wave 4
dat_pheno_W4 <- dat_pheno_W4 %>%
  mutate(
    black = 
      case_when(
        RACE1 == 2 ~ 1,   # black coded as 1
        RACE1 == 1 ~ 0,   # white coded as 0
        TRUE ~ NA_real_   # all other races coded as NA
      ),
    natam =
      case_when(
        RACE1 == 3 ~ 1,   # native american coded as 1
        RACE1 == 1 ~ 0,   # white coded as 0
        TRUE ~ NA_real_   # all other races coded as NA
      ),
    asian =
      case_when(
        RACE1 == 4 ~ 1,   # native american coded as 1
        RACE1 == 1 ~ 0,   # white coded as 0
        TRUE ~ NA_real_   # all other races coded as NA
      )
  )
```

Dummy code SES so each category is compared to high SES:

```{r dummy code SES}
# Wave 2
dat_pheno_W2 <- dat_pheno_W2 %>%
  mutate(
    SES_cat = 
      case_when(
        SES <= quantile(SES, 1/3) ~ "Low",
        SES <= quantile(SES, 2/3) ~ "Middle",
        TRUE ~ "High"
        ),
    SESlow = 
      case_when(
        SES_cat == "Low" ~ 1,    # low ses coded as 1
        SES_cat == "High" ~ 0,   # high ses coded as 0
        TRUE ~ NA_real_          # middle coded as NA
        ), 
    SESmid = 
      case_when(
        SES_cat == "Middle" ~ 1,   # middle ses coded as 1
        SES_cat == "High" ~ 0,     # high ses coded as 0
        TRUE ~ NA_real_            # low coded as NA
        )
  )

# Wave 4
dat_pheno_W4 <- dat_pheno_W4 %>%
  mutate(
    SES_cat = 
      case_when(
        SES <= quantile(SES, 1/3) ~ "Low",
        SES <= quantile(SES, 2/3) ~ "Middle",
        TRUE ~ "High"
        ),
    SESlow = 
      case_when(
        SES_cat == "Low" ~ 1,    # low ses coded as 1
        SES_cat == "High" ~ 0,   # high ses coded as 0
        TRUE ~ NA_real_          # middle coded as NA
        ), 
    SESmid = 
      case_when(
        SES_cat == "Middle" ~ 1,   # middle ses coded as 1
        SES_cat == "High" ~ 0,     # high ses coded as 0
        TRUE ~ NA_real_            # low coded as NA
        )
  )
```

```{r save data}
# save both waves
save(dat_pheno_W2, file = "/home/thom1336/healthdis/data/dat_pheno_W2.RData")
save(dat_pheno_W4, file = "/home/thom1336/healthdis/data/dat_pheno_W4.RData")
```

# PGS prep

**Decide here if we are using 0.1 or 0.8 INFO cut off** 

```{r read and merge multiple PRS files}
ancestries <- c("eur", "amr", "afr", "eas")
sumstats <- c("trans_ADDH")
info <- c("0.1") # CHANGE TO 0.8 IF WANT TO 
```

Read in data

```{r make dataframe with prs}
# format: [IID, score, ancestry, sumstat]
ah_multi_prs_long <- expand.grid(ancestry = ancestries, sumstat = sumstats) %>%
  mutate(file = paste0(sumstat, "_", ancestry, "_sbayesrc.profile")) %>%
  rowwise() %>%
  mutate(data = list(
    read.table(paste0("/home/thom1336/healthdis/data/pgs_prep/results/", info, "/", file), 
               header = TRUE) %>%
      dplyr::select(IID, SCORESUM) %>%
      dplyr::rename(score = SCORESUM) %>%
      mutate(ancestry = toupper(ancestry), sumstat = sumstat)
  )) %>%
  pull(data) %>%
  bind_rows() %>%
  convert_iid_to_char
```

Check data

```{r check prs data}
nrow(ah_multi_prs_long) # 8826 people with PRS 
head(ah_multi_prs_long)

# check missings
ah_multi_prs_long %>%
summarise(
     total_NAs = sum(is.na(score)),
     total_values = n(),
     na_percentage = (total_NAs / total_values) * 100
   )

# distribution of PGS
bar_PGS <- ggplot(ah_multi_prs_long, aes(x = score, fill = ancestry)) +
                 geom_histogram(binwidth = 0.1, color = "black", alpha = 0.7) +
                 labs(title = "Histogram of MDD2025 PRS in Addhealth", x = "Value", y = "Frequency") +
                 theme_minimal()

save_gg_cairo(bar_PGS, "/home/thom1336/healthdis/figures/pgs/bar_PGS.png", width = 1000, height = 650)
```

Recode into quintiles - I decided to do 3 to retain as much sample size in the group comparisons with the hope to include EUR, AFR, and AMR (rather than just EUR). This also matched the low, mid, and high SES groupings. We can further split these for a sensitivity analysis if needed. 

```{r dummy code pgs}
ah_multi_prs_long <- ah_multi_prs_long %>%
  mutate(
    pgs_cat = 
      case_when(
        score <= quantile(score, 1/3) ~ 1,
        score <= quantile(score, 2/3) ~ 2,
        TRUE ~ 3
        ),
    pgs2 = 
      case_when(
        pgs_cat == 2 ~ 1,    # second quintile coded as 1
        pgs_cat == 1 ~ 0,    # low pgs coded as 0
        TRUE ~ NA_real_       
        ), 
    pgs3 = 
      case_when(
        pgs_cat == 3 ~ 1,    # third quintile coded as 1
        pgs_cat == 1 ~ 0,    # low pgs coded as 0
        TRUE ~ NA_real_       
        )
  )

freq(ah_multi_prs_long$pgs_cat)
freq(ah_multi_prs_long$pgs2)
```

```{r read in PCs}
dat_pcs_AFR <- read.table(
  paste0("/project/rche/data/datasets/addhealth/clean_progress/genetic_files/qc/pca/info_cutoff/", info, "/AFR/pca_AFR.eigenvec")) %>% 
  dplyr::select(V2:V12) %>%
  setNames(c("IID", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")) %>%
  convert_iid_to_char %>%
  rename(AID = IID) %>%
  mutate(ancestry = "AFR")

dat_pcs_AMR <- read.table(
  paste0("/project/rche/data/datasets/addhealth/clean_progress/genetic_files/qc/pca/info_cutoff/", info, "/AMR/pca_AMR.eigenvec")) %>% 
  dplyr::select(V2:V12) %>%
  setNames(c("IID", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")) %>%
  convert_iid_to_char %>%
  rename(AID = IID) %>%
  mutate(ancestry = "AMR")

dat_pcs_EAS <- read.table(
  paste0("/project/rche/data/datasets/addhealth/clean_progress/genetic_files/qc/pca/info_cutoff/", info, "/EAS/pca_EAS.eigenvec")) %>% 
  dplyr::select(V2:V12) %>%
  setNames(c("IID", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")) %>%
  convert_iid_to_char %>%
  rename(AID = IID) %>%
  mutate(ancestry = "EAS")

dat_pcs_EUR <- read.table(
  paste0("/project/rche/data/datasets/addhealth/clean_progress/genetic_files/qc/pca/info_cutoff/", info, "/EUR/pca_EUR.eigenvec")) %>% 
  dplyr::select(V2:V12) %>%
  setNames(c("IID", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")) %>%
  convert_iid_to_char %>%
  rename(AID = IID) %>%
  mutate(ancestry = "EUR")

dat_pcs <- rbind(dat_pcs_AFR, dat_pcs_AMR, dat_pcs_EAS, dat_pcs_EUR)
```

```{r select PGS}
ah_multi_prs_long <- ah_multi_prs_long %>%
  rename(pgs = score, AID = IID) %>%
  dplyr::select(-sumstat)

dat_pgs <- inner_join(ah_multi_prs_long, dat_pcs, by = c("AID", "ancestry"))
```

## Regress out ancestry specific pcs

I think there I'll need to do this per ancestry 

```{r regress out ancestry specific pcs}
dat_pgs <- dat_pgs %>%
  group_by(ancestry) %>%
  mutate(
    # fit within each group
    pgs_reg = lm(pgs ~ PC1 + PC2 + PC3 + PC4 + PC5 + PC6 + PC7 + PC8 + PC9 + PC10,
                 data = cur_data_all())$residuals,
    pgs_reg_cat = ntile(pgs_reg, 3)) %>%
  ungroup() %>%
    mutate(
    pgs_reg2 = case_when(
      is.na(pgs_reg_cat)      ~ NA_real_,
      pgs_reg_cat == 2        ~ 1,
      pgs_reg_cat == 1        ~ 0,
      TRUE                    ~ NA_real_
    ),
    pgs_reg3 = case_when(
      is.na(pgs_reg_cat)      ~ NA_real_,
      pgs_reg_cat == 3        ~ 1,
      pgs_reg_cat == 1        ~ 0,
      TRUE                    ~ NA_real_
    )
  )
```

```{r join genetic and social data}
dat_pheno_pgs_W2 <- inner_join(dat_pheno_W2, dat_pgs, by = "AID")
dat_pheno_pgs_W4 <- inner_join(dat_pheno_W4, dat_pgs, by = "AID")

nrow(dat_pheno_pgs_W2) # 4478 people
nrow(dat_pheno_pgs_W4) # 6242 people

# split by ancestry
dat_pheno_pgs_AFR_W2 <- dat_pheno_pgs_W2 %>% dplyr::filter(ancestry == "AFR") # 953 people
dat_pheno_pgs_AMR_W2 <- dat_pheno_pgs_W2 %>% dplyr::filter(ancestry == "AMR") # 428 people
dat_pheno_pgs_EAS_W2 <- dat_pheno_pgs_W2 %>% dplyr::filter(ancestry == "EAS") # 204 people
dat_pheno_pgs_EUR_W2 <- dat_pheno_pgs_W2 %>% dplyr::filter(ancestry == "EUR") # 2893 people

dat_pheno_pgs_AFR_W4 <- dat_pheno_pgs_W4 %>% dplyr::filter(ancestry == "AFR") # 1357 people
dat_pheno_pgs_AMR_W4 <- dat_pheno_pgs_W4 %>% dplyr::filter(ancestry == "AMR") # 609 people
dat_pheno_pgs_EAS_W4 <- dat_pheno_pgs_W4 %>% dplyr::filter(ancestry == "EAS") # 293 people
dat_pheno_pgs_EUR_W4 <- dat_pheno_pgs_W4 %>% dplyr::filter(ancestry == "EUR") # 3983 people
```

```{r check differences in variable}
freq(dat_pheno_pgs_W2$pgs_cat)
freq(dat_pheno_pgs_W2$pgs_reg_cat)

# number of people who match in both 
dat_pheno_pgs_W2 %>%
  mutate(same_category = pgs_cat == pgs_reg_cat) %>%
  group_by(pgs_cat) %>%
  summarise(
    matches = sum(same_category, na.rm = TRUE),
    total = n(),
    proportion_match = matches / total
  )
```

```{r save data}
# save both waves
save(dat_pheno_pgs_W2, file = "/home/thom1336/healthdis/data/dat_pheno_pgs_W2.RData")
save(dat_pheno_pgs_W4, file = "/home/thom1336/healthdis/data/dat_pheno_pgs_W4.RData")

# split by ancestry 
save(dat_pheno_pgs_AFR_W2, file = "/home/thom1336/healthdis/data/dat_pheno_pgs_AFR_W2.RData")
save(dat_pheno_pgs_AMR_W2, file = "/home/thom1336/healthdis/data/dat_pheno_pgs_AMR_W2.RData")
save(dat_pheno_pgs_EAS_W2, file = "/home/thom1336/healthdis/data/dat_pheno_pgs_EAS_W2.RData")
save(dat_pheno_pgs_EUR_W2, file = "/home/thom1336/healthdis/data/dat_pheno_pgs_EUR_W2.RData")

save(dat_pheno_pgs_AFR_W4, file = "/home/thom1336/healthdis/data/dat_pheno_pgs_AFR_W4.RData")
save(dat_pheno_pgs_AMR_W4, file = "/home/thom1336/healthdis/data/dat_pheno_pgs_AMR_W4.RData")
save(dat_pheno_pgs_EAS_W4, file = "/home/thom1336/healthdis/data/dat_pheno_pgs_EAS_W4.RData")
save(dat_pheno_pgs_EUR_W4, file = "/home/thom1336/healthdis/data/dat_pheno_pgs_EUR_W4.RData")
```

EAS and AMR are super small sample sizes - so we will likely have a power issue with these. AMR is better for W4 but still not great. But will see what the confidence intervals come out as anyway. 

```{r check pgs dummy frequencies per ancestry}
freq(dat_pheno_pgs_AFR_W2$pgs3)
freq(dat_pheno_pgs_AMR_W2$pgs3)
freq(dat_pheno_pgs_EAS_W2$pgs3)
freq(dat_pheno_pgs_EUR_W2$pgs3)

freq(dat_pheno_pgs_AFR_W4$pgs3)
freq(dat_pheno_pgs_AMR_W4$pgs3)
freq(dat_pheno_pgs_EAS_W4$pgs3)
freq(dat_pheno_pgs_EUR_W4$pgs3)
```


# Analysis plan 

   M
  / \
 /   \
X-----Y

Y = Depression at W2 and W4
X = Sex / Race / SES / PGS
M = Social / Family / School / Friends / Neighbourhood / Religion  

Dep_XM

This is done in four steps: 

*1.  Create variable for social (M), when X (e.g. Sex) = 0*
First run a model for M: M ~ X (e.g. Social ~ Sex), and extract the intercept and residual. 
Create a new M_X0 variable (e.g. Social) when X = 0, for example: social_sex0 = intercept + coef(Social)*0 + error

*2.  Model for Dep (Y): Y ~ M + X + covariates*
Y ~ X + M + M^2 + X:M + covariate + covariate:X, and save this model to use for 2A and 2B

*2A. Create variable (Dep_00) for Dep (Y), when X = 0 (e.g. Sex = Male) and social (M) when X = 0 (e.g. Sex = Male)*
Dep_00 = intercept + coef(X) * 0 + coef(M) * M_X0 + coef(M^2) * M_X0^2 + coef(X:M) * M_X0 * 0 + coef(covariate) * covariate + coef(covariate:X) * covariate * 0

*2B. Create variable (Dep_10) for Dep (Y), when X = 1 (e.g. Sex = Female) and social (M) when X = 0 (e.g. Sex = Male)*
Dep_01 = intercept + coef(X)     + coef(M) * M_X0 + coef(M^2) * M_X0^2 + coef(X:M) * M_X0     + coef(covariate) * covariate + coef(covariate:X) * covariate

*3.  Model for Dep (Y): Y ~ X + covariates*
Y ~ X + covariate + X:covariate, and save this model to use for 3A and 3B

*3A. Create variable (Dep_0) for Dep (Y), when X = 0 (Sex = Male)*
Dep_0 = intercept + coef(X) * 0 + coef(covariate) * covariate + coef(X:covariate) * covariate * 0

*3B. Create variable (Dep_1) for Dep (Y), when X = 1 (Sex = Female)*
Dep_1 = intercept + coef(X)     + coef(covariate) * covariate + coef(X:covariate) * covariate

*4.  Compute differences in Dep (Y) for males and females (de, tce, dif)*
DE / Interventional Disparity Measure - Direct Effect / Causal Disparity Measure = Dep_10 - Dep 00, gives difference in Dep when X changes but M is set to that of X=0
TCE / Total Causal Effect / Adj-TA / Adjusted Total Association = Dep_1 - Dep_0, total disparity based on X with no mediator
DIF / Difference = TCE - DE, the disparity reduction if we intervened on the mediator

***

# Descriptives

```{r define mediators for loops}
# list of mediators
mediators <- c(
  "family",
  "school",
  "friends",
  "neigh",
  "religion",
  "social"
)

# list of waves and their corresponding data and outcome names
waves <- list(
  W2 = list(
    data = dat_pheno_W2,
    outcome = "CESD_W2"
  ),
  W4 = list(
    data = dat_pheno_W4,
    outcome = "CESD_W4"
  )
)

# list of waves and their corresponding data and outcome names - pgs
waves_pgs <- list(
  W2 = list(
    data = dat_pheno_pgs_W2,
    outcome = "CESD_W2"
  ),
  W4 = list(
    data = dat_pheno_pgs_W4,
    outcome = "CESD_W4"
  )
)
```

## Distribution of CES-D outcome at W2 and W4

```{r distribution of cesd}
for (wave in names(waves)) {
  # loop over the waves
  dat <- waves[[wave]]$data
  outcome_var <- waves[[wave]]$outcome
  
  cesd <- ggplot(dat, aes(x = !!sym(outcome_var))) +
    geom_histogram(aes(y = ..density..), bins = 30, fill = "#3C1642", color = "white", alpha = 0.7) +
    geom_density(color = "#1DD3B0", size = 1.2) +
    labs(
      title = "Distribution of CESD scores",
      x = outcome_var,
      y = "Density"
    ) +
    theme_minimal(base_size = 14)
  
  save_gg_cairo(cesd, paste0("/home/thom1336/healthdis/figures/distributions/", outcome_var, "_hist.png"))
}
```

## Distribution of mediators 

```{r distribution of m}
for (m in mediators) {
    m_plot <- ggplot(dat, aes(x = !!sym(m))) +
      geom_histogram(aes(y = ..density..), bins = 30, fill = "#3C1642", color = "white", alpha = 0.7) +
      geom_density(color = "#1DD3B0", size = 1.2) +
      labs(
      title = paste0("Distribution of mediator: ", m),
      x = m,
      y = "Density"
      ) +
    theme_minimal(base_size = 14)
  
    save_gg_cairo(m_plot, paste0("/home/thom1336/healthdis/figures/distributions/", m, "_hist.png"))
}
```

***

# Sex

## Descriptives

```{r frequency of sex}
freq(dat_pheno_W2$sex)
freq(dat_pheno_W4$sex)
```

```{r sex specific descriptives of mediators}
for (wave in names(waves)) {
  
  dat <- waves[[wave]]$data
  outcome_var <- waves[[wave]]$outcome
  
  for (m in mediators) {
    
    print(
      dat %>%
      group_by(sex) %>%
        summarise(
          mediator = m,
          wave = wave,
          mean = mean(!!sym(m), na.rm = TRUE),
          sd   = sd(!!sym(m), na.rm = TRUE),
          min  = min(!!sym(m), na.rm = TRUE),
          max  = max(!!sym(m), na.rm = TRUE)
        ))
  }
}
```

```{r sex specific descriptives of outcomes}
for (wave in names(waves)) {
  
  dat <- waves[[wave]]$data
  outcome_var <- waves[[wave]]$outcome
  
  for (m in mediators) {
    
    print(
      dat %>%
      group_by(sex) %>%
        summarise(
          outcome = outcome_var,
          wave = wave,
          mean = mean(!!sym(outcome_var), na.rm = TRUE),
          sd   = sd(!!sym(outcome_var), na.rm = TRUE),
          min  = min(!!sym(outcome_var), na.rm = TRUE),
          max  = max(!!sym(outcome_var), na.rm = TRUE)
        ))
  }
}
```

## Correlations

Sex ~ M
Y ~ M
Y ~ Sex

```{r cor between m and y}
blue_shades <- c("#D0E1F9", "#A9C4EB", "#73A1D7", "#4178BE", "#0D47A1")

# loop over waves
for (wave in names(waves)) {
  
  dat <- waves[[wave]]$data
  outcome_var <- waves[[wave]]$outcome
  
  # M ~ X
  for (m in mediators) {
    p1 <- ggplot(dat, aes(x = sex, y = !!sym(m), color = as.factor(sex))) +
      geom_point(alpha = 0.5) +
      geom_smooth(method = "lm", color = "black") +
      scale_color_manual(values = blue_shades) + 
      labs(
        title = paste0("Correlation between sex and social mediator: ", m),
        x = "Sex",
        y = paste0("Social score: ", m)
      ) +
      theme_minimal() +
      theme(legend.position = "none")
  
    save_gg_cairo(p1, paste0("/home/thom1336/healthdis/figures/sex/sex_", m, "_cor.png"))
  }

  # Y ~ M
  for (m in mediators) {
    p2 <- ggplot(dat, aes(x = !!sym(m), y = !!sym(outcome_var), color = as.factor(sex))) +
      geom_point(alpha = 0.5) +
      geom_smooth(method = "lm", color = "black") +
      scale_color_manual(values = blue_shades) + 
      labs(
        title = paste0("Correlation between ", outcome_var, " and social mediator: ", m),
        x = paste0("Social Score: ", m),
        y = outcome_var
      ) +
      theme_minimal() +
      theme(legend.position = "none")
  
    save_gg_cairo(p2, paste0("/home/thom1336/healthdis/figures/sex/", m, "_", outcome_var, "_cor.png"))
  }

  # Y ~ X
  p3 <- ggplot(dat, aes(x = sex, y = !!sym(outcome_var), color = as.factor(sex))) +
      geom_point(alpha = 0.5) +
      geom_smooth(method = "lm", color = "black") +
      scale_color_manual(values = blue_shades) + 
      labs(
        title = paste0("Correlation between ", outcome_var, "and sex"),
        x = "Sex",
        y = outcome_var
      ) +
      theme_minimal() +
      theme(legend.position = "none")
  
    save_gg_cairo(p1, paste0("/home/thom1336/healthdis/figures/sex/", outcome_var, "_sex_cor.png"))
}
```

## Disparity calculation

The below function will loop over W2 and W4 outcomes for all mediators: family, school, friends, neigh, religion, and social. 

In the variable naming, the first number refers to X and the second number to M.

* social_sex0 = the social variable (mediator) when sex = 0
* dep_00_social = the depression variable when sex = 0 AND social variable when sex = 0 (social_sex0)
* dep_10_social = the depression variable when sex = 1 AND social variable when sex = 0 (social_sex0). aka - the depression score for females using what the social score would have been if they were male. 
* dep_0 = total causal effect when sex = 0
* dep_1 = total causal effect when sex = 1

Terminology cross-over:
* DE = IDM-DE = CDM, Direct Effect = Interventional Disparity Measure - Direct Effect = Causal Disparity Measure 
* TCA = Adj-TA, Total Causal Association = Adjusted Total Association

Run the following on Rossmann:
*sbatch /home/thom1336/healthdis/bootstrap_sex.txt*

It will run the R script called bootstrap_sex.R which includes the following R code: 

```{r bootstrapping and montecarlo simluations for counterfactual calculation sex}
# library(purrr)
# library(tidyr)
# library(boot)
# library(tidyverse)
# library(dplyr)
# library(rlang)
# library(magrittr)
# 
# set.seed(123)
# remove(list = ls())
# 
# # load data
# load("/home/thom1336/healthdis/data/dat_pheno_W2.RData")
# load("/home/thom1336/healthdis/data/dat_pheno_W4.RData")
# 
# # list of mediators
# mediators <- c("family", "school", "friends", "neigh", "religion", "social")
# 
# # list of waves and their corresponding data and outcome names
# waves <- list(
#   W2 = list(data = dat_pheno_W2, outcome = "CESD_W2"),
#   W4 = list(data = dat_pheno_W4, outcome = "CESD_W4")
# )
# 
# # function to run counterfactual calculations and Monte Carlo simulations within bootstrapping 
# bootstrap_stat <- function(data, indices, wave_name, mediators) {
#   
#   #--------------------------------------------
#   # Bootstrap sample (original sample)
#   #--------------------------------------------
#   dat <- data[indices, ]
#   dat$original <- 1
#   dat$UM <- rnorm(nrow(dat))  # mediator error (original)
#   dat$UY <- rnorm(nrow(dat))  # outcome error (original)
#   
#   outcome_var <- waves[[wave_name]]$outcome
#   
#   #--------------------------------------------
#   # Monte Carlo expansion (inner loop)
#   #--------------------------------------------
#   dat_expanded <- dat[rep(1:nrow(dat), each = 1000), ]  
#   dat_expanded$original <- rep(c(1, rep(0, 999)), times = nrow(dat))
#   dat_expanded$UM <- rnorm(nrow(dat_expanded))
#   dat_expanded$UY <- rnorm(nrow(dat_expanded))
#   
#   #--------------------------------------------
#   # Counterfactual loop
#   #--------------------------------------------
#   
#   # create a list to store model results
#   model_list_regsex <- list()
#   
#   #----------------------------------------------------
#   # Step 1: Variable for social (M) when sex (X) = 0
#   #----------------------------------------------------
#   
#   for (m in mediators) {
#     # fit model
#     modelM <- lm(as.formula(paste(m, "~ sex")), data = dat)  # fit on original bootstrapped sample
#     
#     # store model in list
#     model_list_regsex[[paste0("model_", m, "_sex")]] <- modelM
#     
#     # extract intercept and residual SD
#     intercept <- coef(modelM)[["(Intercept)"]]
#     resid_sd <- summary(modelM)$sigma
#     
#     # simulate mediator under sex = 0 (on expanded)
#     new_var <- paste0(m, "_sex0")
#     dat_expanded[[new_var]] <- intercept + resid_sd * dat_expanded$UM # applied to all expanded simulations
#     
#     print(summary(dat[[m]]))
#     print(summary(dat_expanded[[new_var]]))
#   }
#   
#   #------------------------------------
#   # Step 2: Model for Dep (Y)
#   #------------------------------------
#   
#   walk(mediators, function(m) {
#     # construct formula for the model
#     formula_str <- paste0(
#       outcome_var, " ~ ",
#       "sex + ", 
#       m, " + ", 
#       m, ":sex + ", 
#       m, "2 + ",
#       "H1GI1Y + sex:H1GI1Y"
#     )
#     
#     formula_obj <- as.formula(formula_str)
#     modelY <- lm(formula_obj, data = dat)  # fit outcome model on original sample
#     model_nameY <- paste0("model_", outcome_var, "_sex_", m)
#     assign(model_nameY, modelY, envir = .GlobalEnv)
#     
#     cat("\n--- Summary for", model_nameY, "---\n")
#     print(summary(modelY))
#   })
#   
#   #-----------------------------------------------------------------------
#   # Step 2A: Variable for Y, when X=0 and M=m_0, using model from Step 2 
#   #----------------------------------------------------------------------
#   
#   walk(mediators, function(m) {
#     model_obj <- get(paste0("model_", outcome_var, "_sex_", m))
#     coefs <- coef(model_obj)
#     rmse <- summary(model_obj)$sigma
#     sex0_var <- sym(paste0(m, "_sex0"))
#     output_var_00 <- sym(paste0(outcome_var, "_00_", m))
#     
#     dat_expanded <<- dat_expanded %>%  # apply prediction values to all expanded data sets
#       mutate(
#         !!output_var_00 :=
#           coefs[["(Intercept)"]] +                                  # intercept
#           (coefs[["sex"]] %||% 0)           * 0 +                   # main effect of sex = 0
#           coefs[[m]]                        * !!sex0_var +          # main effect of mediator
#           (coefs[[paste0("sex:", m)]] %||% 0) * 0 +                 # interaction of sex × mediator when sex = 0
#           coefs[[paste0(m, "2")]]           * (!!sex0_var)^2 +      # quadratic effect of mediator
#           (coefs[["H1GI1Y"]] %||% 0)        * H1GI1Y +              # H1GI1Y main effect
#           (coefs[["sex:H1GI1Y"]] %||% 0)    * H1GI1Y * 0 +          # interaction: sex × H1GI1Y when sex = 0
#           rmse * UY                                                 # residual
#       )
#     
#     cat("Created:", paste0(outcome_var, "_00_", m), "\n")
#   })
#   
#   #----------------------------------------------------------------------
#   # Step 2B: Variable for Y, when X=1 and M=m_0, using model from Step 2 
#   #----------------------------------------------------------------------
#   
#   walk(mediators, function(m) {
#     model_obj <- get(paste0("model_", outcome_var, "_sex_", m))
#     coefs <- coef(model_obj)
#     rmse <- summary(model_obj)$sigma
#     
#     sex0_var   <- sym(paste0(m, "_sex0"))
#     output_var_10 <- sym(paste0(outcome_var, "_10_", m))
#     
#     dat_expanded <<- dat_expanded %>%  # apply prediction values to all expanded data sets
#       mutate(
#         !!output_var_10 :=
#           coefs[["(Intercept)"]] +                                  # intercept
#           coefs[["sex"]] +                                          # main effect of sex = 1
#           coefs[[m]]             * !!sex0_var +                     # main effect of mediator
#           coefs[[paste0("sex:", m)]] * !!sex0_var +                 # interaction: sex × mediator
#           coefs[[paste0(m, "2")]] * (!!sex0_var)^2 +                # quadratic effect of mediator
#           coefs[["H1GI1Y"]]      * H1GI1Y +                         # H1GI1Y main effect
#           coefs[["sex:H1GI1Y"]]  * H1GI1Y +                         # interaction: sex × H1GI1Y
#           rmse * UY                                                 # residual
#       )
#     
#     cat("Created:", paste0(outcome_var, "_10_", m), "\n")
#   })
#   
#   #----------------------------------------------------------------------
#   # Step 3: Model for the Total Causal Effect (TCE), Y ~ X
#   #----------------------------------------------------------------------
#   
#   model <- lm(as.formula(paste0(outcome_var, " ~ sex + H1GI1Y + sex:H1GI1Y")), 
#               data = dat) # computed on original data
#   
#   coefs <- coef(model)
#   
#   #----------------------------------------------------------------------
#   # Step 3A: Variables for Dep (Y), when X=0 (no mediator involved) 
#   #----------------------------------------------------------------------
#   
#   output_var_0 <- sym(paste0(outcome_var, "_0")) # when X=0
#   dat_expanded <- dat_expanded %>% # applied to expanded data
#     mutate(
#       !!output_var_0 :=
#         coefs["(Intercept)"] + 
#         (coefs[["sex"]] %||% 0) * 0 + 
#         coefs["H1GI1Y"] * H1GI1Y +
#         coefs["sex:H1GI1Y"] * H1GI1Y * 0
#     )
#   
#   #----------------------------------------------------------------------
#   # Step 3B: Variables for Dep (Y), when X=1 (no mediator involved) 
#   #----------------------------------------------------------------------
#   
#   output_var_1 <- sym(paste0(outcome_var, "_1")) # when X=1
#   dat_expanded <- dat_expanded %>% # applied to expanded data
#     mutate(
#       !!output_var_1 :=
#         coefs["(Intercept)"] + 
#         coefs["sex"] + 
#         coefs["H1GI1Y"] * H1GI1Y +
#         coefs["sex:H1GI1Y"] * H1GI1Y 
#     )
#   
#   cat("Created:", output_var_0, "\n")
#   cat("Created:", output_var_1, "\n")
#   
#   #--------------------------------------------
#   # Step 4: Compute differences: de, tce, dif
#   #--------------------------------------------
#   
#   walk(mediators, function(m) {
#     de_var <- sym(paste0("de_", "sex_", m))
#     tce_var <- sym(paste0("tce_", "sex_", m))
#     dif_var <- sym(paste0("dif_", "sex_", m))
#     dep_00 <- sym(paste0(outcome_var, "_00_", m))
#     dep_10 <- sym(paste0(outcome_var, "_10_", m))
#     dep_0  <- sym(paste0(outcome_var, "_0"))
#     dep_1  <- sym(paste0(outcome_var, "_1"))
#     
#     dat_expanded <<- dat_expanded %>% # calculated for each expanded dataset
#       mutate(
#         !!de_var := !!dep_10 - !!dep_00,
#         !!tce_var := !!dep_1 - !!dep_0,
#         !!dif_var := !!tce_var - !!de_var
#       )
#   })
#   
#   #-----------------------------------------------------------------
#   # Calulate mean de, tce, and dif across all expanded data sets
#   #-----------------------------------------------------------------
# 
#   effects <- map(mediators, function(m) {
#     c(
#       CDM = mean(dat_expanded[[paste0("de_sex_", m)]], na.rm = TRUE),
#       TCE = mean(dat_expanded[[paste0("tce_sex_", m)]], na.rm = TRUE),
#       DIF = mean(dat_expanded[[paste0("dif_sex_", m)]], na.rm = TRUE)
#     )
#   })
#   
#   names_list <- unlist(map2(mediators, seq_along(mediators),
#                             ~ c(paste0("CDM", .y), paste0("TCE", .y), paste0("DIF", .y))))
#   out <- unlist(effects)
#   names(out) <- names_list
#   return(out)
# }
# 
# #----------------------------------
# # Run Bootstrapping (outer loop)
# #----------------------------------
# 
# for (wave in names(waves)) {
#   cat("\nBootstrapping wave:", wave, "\n")
# 
#   # This re-samples individuals 1000 times to capture sampling variability and calculate confidence intervals 
#   boot_results <- boot(
#     data = waves[[wave]]$data,
#     statistic = function(d, i) bootstrap_stat(d, i, wave_name = wave, mediators = mediators), # runs Monte Carlo expansions within each bootstrap
#     R = 1000
#   )
# 
#   estimates <- boot_results$t
#   col_names <- names(boot_results$t0)
#   
#   # Calculate mean, SE, and percentile confidence intervals
#   results <- tibble(
#     Effect  = col_names,
#     Mean    = boot_results$t0,
#     SE      = apply(estimates, 2, sd, na.rm = TRUE),
#     CI_Low  = apply(estimates, 2, quantile, probs = 0.025, na.rm = TRUE),
#     CI_High = apply(estimates, 2, quantile, probs = 0.975, na.rm = TRUE),
#     Wave    = wave
#   ) %>%
#     # Extract mediator number and effect type (CDM/TCE/DIF)
#     mutate(
#       Mediator_Num = as.numeric(gsub("[^0-9]", "", Effect)),
#       Effect_Type  = gsub("[0-9]", "", Effect),
#       Mediator     = mediators[Mediator_Num],
#       Wave         = wave
#     ) %>%
#     dplyr::select(Wave, Mediator, Effect_Type, Mean, SE, CI_Low, CI_High) # final table
# 
#   saveRDS(results, file = paste0("/home/thom1336/healthdis/data/bootstrap_results_", wave, ".rds"))
#   saveRDS(boot_results, file = paste0("/home/thom1336/healthdis/data/boot_object_", wave, ".rds"))
# 
#   cat("Saved results for wave:", wave, "\n")
# }
```

## Results

* DE / IDM-DE / CDM estimates the disparity that remains after intervening on the mediator (social connection), i.e. the remaining association between sex and depression symptoms if everyone had their social connection level shifted to match that of males.
* TCE / Adj-TA is the total association between sex and depression, after adjusting for covariates.
* DIF reflects the potential mitigation due to intervening on social support and inclusion. Larger differences between Adj-TA and IDM-DE suggest greater scope for intervention.

```{r read in results files}
# Wave 2
results_sex_W2 <- readRDS("/home/thom1336/healthdis/data/sex/bootstrap_results_W2.rds")

# Wave 4
results_sex_W4 <- readRDS("/home/thom1336/healthdis/data/sex/bootstrap_results_W4.rds")

results_sex <- rbind(results_sex_W2, results_sex_W4)

results_sex
```

### Plot

Here, dep_1 and dep_0 are the same across mediators because they come from the total effect model (Y ~ sex + H1GI1Y), which does not include the mediator.

```{r plot sex diff}
plot_data_sex <- results_sex %>%
  filter(Effect_Type %in% c("CDM", "TCE")) %>%
  dplyr::select(Mediator, Wave, Effect_Type, Mean) %>%
  pivot_wider(names_from = Effect_Type, values_from = Mean) %>%
  left_join(
    results_sex %>% 
      filter(Effect_Type == "DIF") %>%
      dplyr::select(Mediator, Wave, DIF = Mean, CI_Low, CI_High), # confidence intervals are for DIF
    by = c("Mediator", "Wave")
  ) %>%
  mutate(
    sig = if_else(CI_Low > 0 | CI_High < 0, TRUE, FALSE),
    Mediator = factor(Mediator, levels = rev(mediators)),
    Wave_Label = factor(Wave, levels = c("W2", "W4"), labels = c("Wave 2", "Wave 4")),
    sex_Label = "Female vs Male"
  )

plot_sex <- ggplot(plot_data_sex, aes(y = Mediator)) +
  # Dumbbell lines
  geom_segment(aes(x = CDM, xend = TCE, yend = Mediator, color = Wave_Label), linewidth = 1) +
  
  # CDM points (mapped to shape)
  geom_point(aes(x = CDM, color = Wave_Label, shape = "CDM"), size = 3) +
  
  # TCE points (mapped to shape)
  geom_point(aes(x = TCE, color = Wave_Label, shape = "TCE"), size = 3) +
  
  # Difference labels
  geom_text(aes(x = (CDM + TCE) / 2, label = paste0("Δ ", round(DIF, 3))),
            vjust = -1, size = 5) +

  # Significance stars
  geom_text(
    data = plot_data_sex %>% dplyr::filter(sig),
    aes(x = (CDM + TCE) / 2, y = Mediator, label = "*"),
    vjust = 1.5, size = 6, color = "black", inherit.aes = FALSE
  ) +
  
  facet_grid(~sex_Label, scales = "free_x") +

  scale_color_manual(values = c("Wave 2" = "#0D0887", "Wave 4" = "#CC4678")) +
  scale_shape_manual(
    name = "",
    values = c("CDM" = 16, "TCE" = 17), # Circle for CDM, triangle for TCE
    labels = c("Association after intervention (CDM)", "Total causal association (TCE)")
  ) +
  
  labs(
    title = "Association between Sex and depression symptoms across if we intervened on social support and inclusion",
    subtitle = paste0("W2 N = ", nrow(dat_pheno_W2), "; W4 N = ", nrow(dat_pheno_W4), "; Reference group = Males",
                      " \n1000 Monte Carlo expansions and Confidence Intervals calculated through 1000 Bootstraps"),
    x = "Estimate (95% Confidence Interval)",
    y = "Areas of social support and inclusion",
    color = "",
    caption = "* indicates a significant reduction in disparity due to social inclusion intervention"
  ) +
  scale_y_discrete(labels = c(
    "family"   = "Family Acceptance and Support",
    "school"   = "School Belonging",
    "friends"  = "Friendship Connections",
    "neigh"    = "Neighbourhood Cohesion",
    "religion" = "Religious Involvement",
    "social"   = "Overall Social Connection and Inclusion"
  )) +
  scale_x_continuous(limits = c(0, 0.3), breaks = seq(0, 1.4, by = 0.1)) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.major.y = element_blank(),
    legend.position = "bottom",
    plot.title.position = "plot",   
    plot.title = element_text(hjust = 0.5, size = 14),
    plot.subtitle = element_text(hjust = 0.5, face = "italic", size = 12),
    axis.title.x = element_text(margin = margin(t = 12)),
    axis.title.y = element_text(margin = margin(r = 12)),
    plot.caption = element_text(hjust = -3, face = "italic", size = 10)
  )

save_gg_cairo(plot_sex, "/home/thom1336/healthdis/figures/sex/results_sex.png", width = 900, height = 450)
```

### Table

```{r sex results table}
results_sex_clean <- results_sex %>%
  mutate(Label = "Female vs Male") %>%
  dplyr::select(Wave, Mediator, Label, `Effect Type` = Effect_Type, `Effect Estimate` = Mean, `CI Low` = CI_Low, `CI High` = CI_High)

results_sex_clean # all confidence intervals included

results_sex_all <- plot_data_sex %>%
  mutate(`Percent difference` = (TCE - CDM) / TCE * 100) %>%
  dplyr::select(Wave, Mediator, Label = sex_Label, CDM, TCE, DIF, `CI Low` = CI_Low, `CI High` = CI_High, `Percent difference`)

results_sex_all # dif confidence intervals and percentage decrease
```

***

# Race

## Descriptives

1 = White
2 = Black
3 = Native American
4 = Asian

```{r frequency of race}
freq(dat_pheno_W2$RACE1)
freq(dat_pheno_W4$RACE1)
```

```{r race specific descriptives of mediators}
stats_by_race <- map_dfr(names(waves), function(wave) {
  dat <- waves[[wave]]$data
  
  dat %>%
    mutate(
      wave = wave,
      Race = case_when(
        RACE1 == 1 ~ "White",
        RACE1 == 2 ~ "Black",
        RACE1 == 3 ~ "Native American",
        RACE1 == 4 ~ "Asian",
        TRUE ~ NA_character_
      )
    ) %>%
    pivot_longer(all_of(mediators), names_to = "mediator", values_to = "value") %>%
    group_by(wave, Race, mediator) %>%
    summarise(
      mean = mean(value, na.rm = TRUE),
      sd   = sd(value, na.rm = TRUE),
      min  = min(value, na.rm = TRUE),
      max  = max(value, na.rm = TRUE),
      .groups = "drop"
    )
})

# look at table
dplyr::arrange(stats_by_race, mediator, wave, Race) %>%
  mutate(across(where(is.numeric), ~ round(.x, 4)))
```

## Correlations

Race ~ M
Y ~ M
Y ~ Race

```{r cor between m and y}
blue_shades <- c("#D0E1F9", "#A9C4EB", "#73A1D7", "#4178BE", "#0D47A1")

# loop over waves
for (wave in names(waves)) {
  
  dat <- waves[[wave]]$data
  outcome_var <- waves[[wave]]$outcome
  
  # M ~ X
  for (m in mediators) {
    p1 <- ggplot(dat, aes(x = RACE1, y = !!sym(m), color = as.factor(RACE1))) +
      geom_point(alpha = 0.5) +
      geom_smooth(method = "lm", color = "black") +
      scale_color_manual(values = blue_shades) + 
      labs(
        title = paste0("Correlation between Race and social mediator: ", m),
        x = "Race",
        y = paste0("Social score: ", m)
      ) +
      theme_minimal() +
      theme(legend.position = "none")
  
    save_gg_cairo(p1, paste0("/home/thom1336/healthdis/figures/race/Race_", m, "_cor.png"))
  }

  # Y ~ M
  for (m in mediators) {
    p2 <- ggplot(dat, aes(x = !!sym(m), y = !!sym(outcome_var), color = as.factor(RACE1))) +
      geom_point(alpha = 0.5) +
      geom_smooth(method = "lm", color = "black") +
      scale_color_manual(values = blue_shades) + 
      labs(
        title = paste0("Correlation between ", outcome_var, " and social mediator: ", m),
        x = paste0("Social Score: ", m),
        y = outcome_var
      ) +
      theme_minimal() +
      theme(legend.position = "none")
  
    save_gg_cairo(p2, paste0("/home/thom1336/healthdis/figures/race/", m, "_", outcome_var, "_cor.png"))
  }

  # Y ~ X
  p3 <- ggplot(dat, aes(x = RACE1, y = !!sym(outcome_var), color = as.factor(RACE1))) +
      geom_point(alpha = 0.5) +
      geom_smooth(method = "lm", color = "black") +
      scale_color_manual(values = blue_shades) + 
      labs(
        title = paste0("Correlation between ", outcome_var, "and Race"),
        x = "Race",
        y = outcome_var
      ) +
      theme_minimal() +
      theme(legend.position = "none")
  
    save_gg_cairo(p1, paste0("/home/thom1336/healthdis/figures/race/", outcome_var, "_Race_cor.png"))
}
```


## Disparity calculation

The below function will loop over W2 and W4 outcomes for all mediators: family, school, friends, neigh, religion, and social. 

In the variable naming, the first number refers to X and the second number to M.

* social_race0 = the social variable (mediator) when race = 0 (white)
* dep_00_social = the depression variable when race = 0 AND social variable when race = 0 (social_race0)
* dep_10_social = the depression variable when race = 1 AND social variable when race = 0 (social_race0). aka - the depression score for black people using what the social score would have been if they were white. 
* dep_0 = total causal effect when race = 0
* dep_1 = total causal effect when race = 1

Terminology cross-over:
* DE = IDM-DE = CDM, Direct Effect = Interventional Disparity Measure - Direct Effect = Causal Disparity Measure 
* TCA = Adj-TA, Total Causal Association = Adjusted Total Association

Run the following on Rossmann:
*sbatch /home/thom1336/healthdis/bootstrap_race.txt*

It will run the R script called bootstrap_race.R which includes the following R code: 

```{r bootstrapping and montecarlo simluations for counterfactual calculation race}
# library(purrr)
# library(tidyr)
# library(boot)
# library(tidyverse)
# library(dplyr)
# library(rlang)
# library(magrittr)
# 
# set.seed(123)
# remove(list = ls())
# 
# # load data
# load("/home/thom1336/healthdis/data/dat_pheno_W2.RData")
# load("/home/thom1336/healthdis/data/dat_pheno_W4.RData")
# 
# # list of mediators
# mediators <- c("family", "school", "friends", "neigh", "religion", "social")
# 
# # list of waves and their corresponding data and outcome names
# waves <- list(
#   W2 = list(data = dat_pheno_W2, outcome = "CESD_W2"),
#   W4 = list(data = dat_pheno_W4, outcome = "CESD_W4")
# )
# 
# # list of racial variables
# race_vars <- c("black", "asian", "natam") 
# 
# # function to run counterfactual calculations and Monte Carlo simulations within bootstrapping 
# bootstrap_stat <- function(data, indices, wave_name, mediators, race_var) {
#   
#   #--------------------------------------------
#   # Bootstrap sample (original sample)
#   #--------------------------------------------
#   dat <- data[indices, ]
#   dat$original <- 1
#   dat$UM <- rnorm(nrow(dat))  # mediator error (original)
#   dat$UY <- rnorm(nrow(dat))  # outcome error (original)
#   
#   outcome_var <- waves[[wave_name]]$outcome
#   
#   #--------------------------------------------
#   # Monte Carlo expansion (inner loop)
#   #--------------------------------------------
#   dat_expanded <- dat[rep(1:nrow(dat), each = 1000), ]  
#   dat_expanded$original <- rep(c(1, rep(0, 999)), times = nrow(dat))
#   dat_expanded$UM <- rnorm(nrow(dat_expanded))
#   dat_expanded$UY <- rnorm(nrow(dat_expanded))
#   
#   #--------------------------------------------
#   # Counterfactual loop
#   #--------------------------------------------
#   
#   # create a list to store model results
#   model_list_reg <- list()
#   
#   #----------------------------------------------------
#   # Step 1: Variable for social (M) when race_var = 0
#   #----------------------------------------------------
#   
#   for (m in mediators) {
#     # fit model
#     modelM <- lm(as.formula(paste(m, "~", race_var)), data = dat)  # fit on original bootstrapped sample
#     
#     # store model in list
#     model_list_reg[[paste0("model_", m, "_", race_var)]] <- modelM
#     
#     # extract intercept and residual SD
#     intercept <- coef(modelM)[["(Intercept)"]]
#     resid_sd <- summary(modelM)$sigma
#     
#     # simulate mediator under race_var = 0 (on expanded)
#     new_var <- paste0(m, "_", race_var, "0")
#     dat_expanded[[new_var]] <- intercept + resid_sd * dat_expanded$UM # applied to all expanded simulations
#     
#     print(summary(dat[[m]]))
#     print(summary(dat_expanded[[new_var]]))
#   }
#   
#   #------------------------------------
#   # Step 2: Model for Dep (Y)
#   #------------------------------------
#   
#   walk(mediators, function(m) {
#     # construct formula for the model
#     formula_str <- paste0(
#       outcome_var, " ~ ",
#       race_var, " + ", 
#       m, " + ", 
#       m, ":", race_var, " + ", 
#       m, "2 + ",
#       "H1GI1Y +", race_var, ":H1GI1Y"
#     )
#     
#     formula_obj <- as.formula(formula_str)
#     modelY <- lm(formula_obj, data = dat)  # fit outcome model on original sample
#     model_nameY <- paste0("model_", outcome_var, "_", race_var, "_", m)
#     assign(model_nameY, modelY, envir = .GlobalEnv)
#     
#     cat("\n--- Summary for", model_nameY, "---\n")
#     print(summary(modelY))
#   })
#   
#   #-----------------------------------------------------------------------
#   # Step 2A: Variable for Y, when race_var = 0 and M=m_0, using model from Step 2 
#   #----------------------------------------------------------------------
#   
#   walk(mediators, function(m) {
#     model_obj <- get(paste0("model_", outcome_var, "_", race_var, "_", m))
#     coefs <- coef(model_obj)
#     rmse <- summary(model_obj)$sigma
#     race0_var <- sym(paste0(m, "_", race_var, "0"))
#     output_var_00 <- sym(paste0(outcome_var, "_00_", m))
#     
#     dat_expanded <<- dat_expanded %>%  # apply prediction values to all expanded data sets
#       mutate(
#         !!output_var_00 :=
#           coefs[["(Intercept)"]] +                                        # intercept
#           (coefs[[race_var]] %||% 0)           * 0 +                      # main effect of race_var = 0
#           coefs[[m]]                        * !!race0_var +               # main effect of mediator
#           (coefs[[paste0(race_var, ":", m)]] %||% 0) * 0 +                # interaction of race_var × mediator when race_var = 0
#           coefs[[paste0(m, "2")]]           * (!!race0_var)^2 +           # quadratic effect of mediator
#           (coefs[["H1GI1Y"]] %||% 0)        * H1GI1Y +                    # H1GI1Y main effect
#           (coefs[[paste0(race_var, ":H1GI1Y")]] %||% 0)    * H1GI1Y * 0 + # interaction: race_var × H1GI1Y when race_var = 0
#           rmse * UY                                                       # residual
#       )
#     
#     cat("Created:", paste0(outcome_var, "_00_", m), "\n")
#   })
#   
#   #----------------------------------------------------------------------
#   # Step 2B: Variable for Y, when race_var = 1 and M=m_0, using model from Step 2 
#   #----------------------------------------------------------------------
#   
#   walk(mediators, function(m) {
#     model_obj <- get(paste0("model_", outcome_var, "_", race_var, "_", m))
#     coefs <- coef(model_obj)
#     rmse <- summary(model_obj)$sigma
#     
#     race0_var   <- sym(paste0(m, "_", race_var, "0"))
#     output_var_10 <- sym(paste0(outcome_var, "_10_", m))
#     
#     dat_expanded <<- dat_expanded %>%  # apply prediction values to all expanded data sets
#       mutate(
#         !!output_var_10 :=
#           coefs[["(Intercept)"]] +                                  # intercept
#           coefs[[race_var]] +                                       # main effect of race_var = 1
#           coefs[[m]]             * !!race0_var +                    # main effect of mediator
#           coefs[[paste0(race_var, ":", m)]] * !!race0_var +         # interaction: race_var × mediator
#           coefs[[paste0(m, "2")]] * (!!race0_var)^2 +               # quadratic effect of mediator
#           coefs[["H1GI1Y"]]      * H1GI1Y +                         # H1GI1Y main effect
#           coefs[[paste0(race_var, ":H1GI1Y")]]  * H1GI1Y +          # interaction: race_var × H1GI1Y
#           rmse * UY                                                 # residual
#       )
#     
#     cat("Created:", paste0(outcome_var, "_10_", m), "\n")
#   })
#   
#   #----------------------------------------------------------------------  
#   # Step 3: Model for the Total Causal Effect (TCE), Y ~ X
#   #----------------------------------------------------------------------
#   
#   model <- lm(as.formula(paste0(outcome_var, " ~ ", race_var, " + H1GI1Y +", race_var, ":H1GI1Y")), 
#               data = dat) # computed on original data
#   
#   coefs <- coef(model)
#   
#   #----------------------------------------------------------------------
#   # Step 3A: Variables for Dep (Y), when race_var = 0 (no mediator involved) 
#   #----------------------------------------------------------------------
#   
#   output_var_0 <- sym(paste0(outcome_var, "_0")) # when race_var = 0
#   dat_expanded <- dat_expanded %>% # applied to expanded data
#     mutate(
#       !!output_var_0 :=
#         coefs["(Intercept)"] + 
#         (coefs[[race_var]] %||% 0) * 0 + 
#         coefs["H1GI1Y"] * H1GI1Y +
#         coefs["sex:H1GI1Y"] * H1GI1Y * 0
#     )
#   
#   #----------------------------------------------------------------------
#   # Step 3B: Variables for Dep (Y), when race_var = 1 (no mediator involved) 
#   #----------------------------------------------------------------------
#   
#   output_var_1 <- sym(paste0(outcome_var, "_1")) # when race_var = 1
#   dat_expanded <- dat_expanded %>% # applied to expanded data
#     mutate(
#       !!output_var_1 :=
#         coefs["(Intercept)"] + 
#         coefs[[race_var]] + 
#         coefs["H1GI1Y"] * H1GI1Y +
#         coefs["sex:H1GI1Y"] * H1GI1Y 
#     )
#   
#   cat("Created:", output_var_0, "\n")
#   cat("Created:", output_var_1, "\n")
#   
#   #--------------------------------------------
#   # Step 4: Compute differences: de, tce, dif
#   #--------------------------------------------
#   
#   walk(mediators, function(m) {
#     de_var <- sym(paste0("de_", race_var, "_", m))
#     tce_var <- sym(paste0("tce_", race_var, "_", m))
#     dif_var <- sym(paste0("dif_", race_var, "_", m))
#     dep_00 <- sym(paste0(outcome_var, "_00_", m))
#     dep_10 <- sym(paste0(outcome_var, "_10_", m))
#     dep_0  <- sym(paste0(outcome_var, "_0"))
#     dep_1  <- sym(paste0(outcome_var, "_1"))
#     
#     dat_expanded <<- dat_expanded %>% # calculated for each expanded dataset
#       mutate(
#         !!de_var := !!dep_10 - !!dep_00,
#         !!tce_var := !!dep_1 - !!dep_0,
#         !!dif_var := !!tce_var - !!de_var
#       )
#   })
#   
#   #-----------------------------------------------------------------
#   # Calulate mean de, tce, and dif across all expanded data sets
#   #-----------------------------------------------------------------
#   
#   effects <- map(mediators, function(m) {
#     c(
#       CDM = mean(dat_expanded[[paste0("de_", race_var, "_", m)]], na.rm = TRUE),
#       TCE = mean(dat_expanded[[paste0("tce_", race_var, "_", m)]], na.rm = TRUE),
#       DIF = mean(dat_expanded[[paste0("dif_", race_var, "_", m)]], na.rm = TRUE)
#     )
#   })
#   
#   names_list <- unlist(map2(mediators, seq_along(mediators),
#                             ~ c(paste0("CDM", .y), paste0("TCE", .y), paste0("DIF", .y))))
#   out <- unlist(effects)
#   names(out) <- names_list
#   return(out)
# }
# 
# #----------------------------------
# # Run Bootstrapping (outer loop)
# #----------------------------------
# 
# for (wave in names(waves)) {
#   for (race_var in race_vars) {  # NEW LINE: Nested loop over each race variable
#     cat("\nBootstrapping wave:", wave, "for race variable:", race_var, "\n")
#     
#     # This re-samples individuals 1000 times to capture sampling variability and calculate confidence intervals 
#     boot_results <- boot(
#       data = waves[[wave]]$data,
#       statistic = function(d, i) bootstrap_stat(d, i, wave_name = wave, mediators = mediators, race_var = race_var), # loops through race_var
#       R = 1000
#     )
#     
#     estimates <- boot_results$t
#     col_names <- names(boot_results$t0)
#     
#     # Calculate mean, SE, and percentile confidence intervals
#     results <- tibble(
#       Effect  = col_names,
#       Mean    = boot_results$t0,
#       SE      = apply(estimates, 2, sd, na.rm = TRUE),
#       CI_Low  = apply(estimates, 2, quantile, probs = 0.025, na.rm = TRUE),
#       CI_High = apply(estimates, 2, quantile, probs = 0.975, na.rm = TRUE),
#       Wave    = wave,
#       Race    = race_var  # Add the race variable to the results
#     ) %>%
#       # Extract mediator number and effect type (CDM/TCE/DIF)
#       mutate(
#         Mediator_Num = as.numeric(gsub("[^0-9]", "", Effect)),
#         Effect_Type  = gsub("[0-9]", "", Effect),
#         Mediator     = mediators[Mediator_Num],
#         Wave         = wave
#       ) %>%
#       dplyr::select(Wave, Race, Mediator, Effect_Type, Mean, SE, CI_Low, CI_High) # final table
#     
#     saveRDS(results, file = paste0("/home/thom1336/healthdis/data/race/bootstrap_results_", wave, "_", race_var, ".rds"))
#     saveRDS(boot_results, file = paste0("/home/thom1336/healthdis/data/race/boot_object_", wave, "_", race_var, ".rds"))
#     
#     cat("Saved results for wave:", wave, "and race variable:", race_var, "\n")
#   }
# }
```

## Results

* DE / IDM-DE / CDM estimates the disparity that remains after intervening on the mediator (social connection), i.e. the remaining association between race and depression symptoms if everyone had their social connection level shifted to match that of white people. 
* TCE / Adj-TA is the total association between race and depression, after adjusting for covariates.
* DIF reflects the potential mitigation due to intervening on social support and inclusion. Larger differences between Adj-TA and IDM-DE suggest greater scope for intervention.

```{r read in results files}
# Wave 2
results_raceblack_W2 <- readRDS("/home/thom1336/healthdis/data/race/bootstrap_results_W2_black.rds")
results_racenatam_W2 <- readRDS("/home/thom1336/healthdis/data/race/bootstrap_results_W2_natam.rds")
results_raceasian_W2 <- readRDS("/home/thom1336/healthdis/data/race/bootstrap_results_W2_asian.rds")

# Wave 4
results_raceblack_W4 <- readRDS("/home/thom1336/healthdis/data/race/bootstrap_results_W4_black.rds")
results_racenatam_W4 <- readRDS("/home/thom1336/healthdis/data/race/bootstrap_results_W4_natam.rds")
results_raceasian_W4 <- readRDS("/home/thom1336/healthdis/data/race/bootstrap_results_W4_asian.rds")

results_race <- rbind(results_raceblack_W2, results_racenatam_W2, results_raceasian_W2,
                      results_raceblack_W4, results_racenatam_W4, results_raceasian_W4)

# filter out native american (power issues)
results_race_Nam <- results_race %>% dplyr::filter(Race != "natam")
```

### Plot

Here, dep_1 and dep_0 are the same across mediators because they come from the total effect model (Y ~ race + H1GI1Y), which does not include the mediator.

```{r plot race}
plot_race_data_ <- results_race_Nam %>%
  filter(Effect_Type %in% c("CDM", "TCE")) %>%
  dplyr::select(Mediator, Race, Wave, Effect_Type, Mean) %>%
  pivot_wider(names_from = Effect_Type, values_from = Mean) %>%
  left_join(
    results_race %>% 
      filter(Effect_Type == "DIF") %>%
      dplyr::select(Mediator, Race, Wave, DIF = Mean, CI_Low, CI_High), # confidence intervals are for DIF
    by = c("Mediator", "Wave", "Race")
  ) %>%
  mutate(
    sig = if_else(CI_Low > 0 | CI_High < 0, TRUE, FALSE),
    Mediator = factor(Mediator, levels = rev(mediators)),
    Wave_Label = factor(Wave, levels = c("W2", "W4"), labels = c("Wave 2", "Wave 4")),
    y_adj = as.numeric(Mediator) + if_else(Wave_Label == "Wave 4", -0.4, 0),
    Race_Label = factor(recode(as.character(Race),
      "black" = "Black vs White",
   #   "natam" = "Native American vs White",
      "asian" = "Asian vs White"
    ))
  )

facet_limits <- tibble::tibble(
  Race_Label = factor(c(
    "Asian vs White", 
    "Black vs White" 
 #   ,"Native American vs White"
  ), levels = levels(plot_race_data_$Race_Label)),
  x_min = c(0, 0),
  x_max = c(0.3, 0.3)
)

plot_race_data_ <- plot_race_data_ %>%
  left_join(facet_limits, by = "Race_Label")

plot_race <- ggplot(plot_race_data_, aes(y = Mediator)) +
  # Dumbbell lines
  geom_segment(aes(x = CDM, xend = TCE, y = y_adj, yend = y_adj, color = Wave_Label), linewidth = 1) +
  
  # CDM points (mapped to shape)
  geom_point(aes(x = CDM, y = y_adj, color = Wave_Label, shape = "CDM"), size = 3) +
  
  # TCE points (mapped to shape)
  geom_point(aes(x = TCE, y = y_adj, color = Wave_Label, shape = "TCE"), size = 3) +
  
  # Difference labels
  geom_text(aes(x = (CDM + TCE) / 2, y = y_adj, label = paste0("Δ ", round(DIF, 3))),
            vjust = -1, size = 5) +

  # Significance stars
  geom_text(
  data = plot_race_data_ %>% dplyr::filter(sig),
  aes(x = (CDM + TCE) / 2, y = y_adj, label = "*"),
  vjust = 1.5, size = 6, color = "black", inherit.aes = FALSE) +
  
  facet_grid(~Race_Label, scales = "free_x") +
  geom_blank(aes(x = x_min)) +
  geom_blank(aes(x = x_max)) +

  scale_color_manual(values = c("Wave 2" = "#0D0887", "Wave 4" = "#CC4678")) +
  scale_shape_manual(
    name = "",
    values = c("CDM" = 16, "TCE" = 17), # Circle for CDM, triangle for TCE
    labels = c("Association after intervention (CDM)", "Total causal association (TCE)")
  ) +
  
  labs(
    title = "Association between Race and depression symptoms across if we intervened on social support and inclusion",
    subtitle = paste0("W2 N = ", nrow(dat_pheno_W2), "; W4 N = ", nrow(dat_pheno_W4), "; Reference group = White people",
                      " \n1000 Monte Carlo expansions and Confidence Intervals calculated through 1000 Bootstraps"),
    x = "Estimate (95% Confidence Interval)",
    y = "Areas of social support and inclusion",
    color = "",
    caption = "* indicates a significant reduction in disparity due to social inclusion intervention"
  ) +
  scale_y_discrete(labels = c(
    "family"   = "Family Acceptance and Support",
    "school"   = "School Belonging",
    "friends"  = "Friendship Connections",
    "neigh"    = "Neighbourhood Cohesion",
    "religion" = "Religious Involvement",
    "social"   = "Overall Social Connection and Inclusion"
  )) +
 # scale_x_continuous(limits = c(0.1, 0.3), breaks = seq(0, 1.4, by = 0.1)) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.major.y = element_blank(),
    legend.position = "bottom",
    plot.title.position = "plot",   
    plot.title = element_text(hjust = 0.5, size = 14),
    plot.subtitle = element_text(hjust = 0.5, face = "italic", size = 12),
    axis.title.x = element_text(margin = margin(t = 12)),
    axis.title.y = element_text(margin = margin(r = 12)),
    plot.caption = element_text(hjust = -3, face = "italic", size = 10)
  )

save_gg_cairo(plot_race, "/home/thom1336/healthdis/figures/race/results_race.png", width = 1300, height = 600)
```

Create separate Asian and Black plots for join plot. 

```{r plot race fo rjoint plot}
plot_race_data_asian <- results_race_Nam %>%
  dplyr::filter(Race == "asian") %>%
  filter(Effect_Type %in% c("CDM", "TCE")) %>%
  dplyr::select(Mediator, Race, Wave, Effect_Type, Mean) %>%
  pivot_wider(names_from = Effect_Type, values_from = Mean) %>%
  left_join(
    results_race %>% 
      filter(Effect_Type == "DIF") %>%
      dplyr::select(Mediator, Race, Wave, DIF = Mean, CI_Low, CI_High), # confidence intervals are for DIF
    by = c("Mediator", "Wave", "Race")
  ) %>%
  mutate(
    sig = if_else(CI_Low > 0 | CI_High < 0, TRUE, FALSE),
    Mediator = factor(Mediator, levels = rev(mediators)),
    Wave_Label = factor(Wave, levels = c("W2", "W4"), labels = c("Wave 2", "Wave 4")),
    y_adj = as.numeric(Mediator) + if_else(Wave_Label == "Wave 4", -0.4, 0),
    Race_Label = factor(recode(as.character(Race),
   #    "black" = "Black vs White",
   #   "natam" = "Native American vs White",
      "asian" = "Asian vs White"
    ))
  )

facet_limits <- tibble::tibble(
  Race_Label = factor(c(
    "Asian vs White" 
 #  , "Black vs White" 
 #   ,"Native American vs White"
  ), levels = levels(plot_race_data_asian$Race_Label)),
  x_min = c(0),
  x_max = c(0.3)
)

plot_race_data_asian <- plot_race_data_asian %>%
  left_join(facet_limits, by = "Race_Label")

plot_race_asian <- ggplot(plot_race_data_asian, aes(y = Mediator)) +
  # Dumbbell lines
  geom_segment(aes(x = CDM, xend = TCE, y = y_adj, yend = y_adj, color = Wave_Label), linewidth = 1) +
  
  # CDM points (mapped to shape)
  geom_point(aes(x = CDM, y = y_adj, color = Wave_Label, shape = "CDM"), size = 3) +
  
  # TCE points (mapped to shape)
  geom_point(aes(x = TCE, y = y_adj, color = Wave_Label, shape = "TCE"), size = 3) +
  
  # Difference labels
  geom_text(aes(x = (CDM + TCE) / 2, y = y_adj, label = paste0("Δ ", round(DIF, 3))),
            vjust = -1, size = 5) +

  # Significance stars
  geom_text(
  data = plot_race_data_asian %>% dplyr::filter(sig),
  aes(x = (CDM + TCE) / 2, y = y_adj, label = "*"),
  vjust = 1.5, size = 6, color = "black", inherit.aes = FALSE) +
  
  facet_grid(~Race_Label, scales = "free_x") +
  geom_blank(aes(x = x_min)) +
  geom_blank(aes(x = x_max)) +

  scale_color_manual(values = c("Wave 2" = "#0D0887", "Wave 4" = "#CC4678")) +
  scale_shape_manual(
    name = "",
    values = c("CDM" = 16, "TCE" = 17), # Circle for CDM, triangle for TCE
    labels = c("Association after intervention (CDM)", "Total causal association (TCE)")
  ) +
  
  labs(
    title = "Association between Race and depression symptoms across if we intervened on social support and inclusion",
    subtitle = paste0("W2 N = ", nrow(dat_pheno_W2), "; W4 N = ", nrow(dat_pheno_W4), "; Reference group = White people",
                      " \n1000 Monte Carlo expansions and Confidence Intervals calculated through 1000 Bootstraps"),
    x = "Estimate (95% Confidence Interval)",
    y = "Areas of social support and inclusion",
    color = "",
    caption = "* indicates a significant reduction in disparity due to social inclusion intervention"
  ) +
  scale_y_discrete(labels = c(
    "family"   = "Family Acceptance and Support",
    "school"   = "School Belonging",
    "friends"  = "Friendship Connections",
    "neigh"    = "Neighbourhood Cohesion",
    "religion" = "Religious Involvement",
    "social"   = "Overall Social Connection and Inclusion"
  )) +
 # scale_x_continuous(limits = c(0.1, 0.3), breaks = seq(0, 1.4, by = 0.1)) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.major.y = element_blank(),
    legend.position = "bottom",
    plot.title.position = "plot",   
    plot.title = element_text(hjust = 0.5, size = 14),
    plot.subtitle = element_text(hjust = 0.5, face = "italic", size = 12),
    axis.title.x = element_text(margin = margin(t = 12)),
    axis.title.y = element_text(margin = margin(r = 12)),
    plot.caption = element_text(hjust = -3, face = "italic", size = 10)
  )

plot_race_data_black <- results_race_Nam %>%
  dplyr::filter(Race == "black") %>%
  filter(Effect_Type %in% c("CDM", "TCE")) %>%
  dplyr::select(Mediator, Race, Wave, Effect_Type, Mean) %>%
  pivot_wider(names_from = Effect_Type, values_from = Mean) %>%
  left_join(
    results_race %>% 
      filter(Effect_Type == "DIF") %>%
      dplyr::select(Mediator, Race, Wave, DIF = Mean, CI_Low, CI_High), # confidence intervals are for DIF
    by = c("Mediator", "Wave", "Race")
  ) %>%
  mutate(
    sig = if_else(CI_Low > 0 | CI_High < 0, TRUE, FALSE),
    Mediator = factor(Mediator, levels = rev(mediators)),
    Wave_Label = factor(Wave, levels = c("W2", "W4"), labels = c("Wave 2", "Wave 4")),
    y_adj = as.numeric(Mediator) + if_else(Wave_Label == "Wave 4", -0.4, 0),
    Race_Label = factor(recode(as.character(Race),
       "black" = "Black vs White"
   #   "natam" = "Native American vs White",
   #   "asian" = "Asian vs White"
    ))
  )

facet_limits <- tibble::tibble(
  Race_Label = factor(c(
 #  "Asian vs White" 
    "Black vs White" 
 #   ,"Native American vs White"
  ), levels = levels(plot_race_data_black$Race_Label)),
  x_min = c(0),
  x_max = c(0.3)
)

plot_race_data_black <- plot_race_data_black %>%
  left_join(facet_limits, by = "Race_Label")

plot_race_black <- ggplot(plot_race_data_black, aes(y = Mediator)) +
  # Dumbbell lines
  geom_segment(aes(x = CDM, xend = TCE, y = y_adj, yend = y_adj, color = Wave_Label), linewidth = 1) +
  
  # CDM points (mapped to shape)
  geom_point(aes(x = CDM, y = y_adj, color = Wave_Label, shape = "CDM"), size = 3) +
  
  # TCE points (mapped to shape)
  geom_point(aes(x = TCE, y = y_adj, color = Wave_Label, shape = "TCE"), size = 3) +
  
  # Difference labels
  geom_text(aes(x = (CDM + TCE) / 2, y = y_adj, label = paste0("Δ ", round(DIF, 3))),
            vjust = -1, size = 5) +

  # Significance stars
  geom_text(
  data = plot_race_data_black %>% dplyr::filter(sig),
  aes(x = (CDM + TCE) / 2, y = y_adj, label = "*"),
  vjust = 1.5, size = 6, color = "black", inherit.aes = FALSE) +
  
  facet_grid(~Race_Label, scales = "free_x") +
  geom_blank(aes(x = x_min)) +
  geom_blank(aes(x = x_max)) +

  scale_color_manual(values = c("Wave 2" = "#0D0887", "Wave 4" = "#CC4678")) +
  scale_shape_manual(
    name = "",
    values = c("CDM" = 16, "TCE" = 17), # Circle for CDM, triangle for TCE
    labels = c("Association after intervention (CDM)", "Total causal association (TCE)")
  ) +
  
  labs(
    title = "Association between Race and depression symptoms across if we intervened on social support and inclusion",
    subtitle = paste0("W2 N = ", nrow(dat_pheno_W2), "; W4 N = ", nrow(dat_pheno_W4), "; Reference group = White people",
                      " \n1000 Monte Carlo expansions and Confidence Intervals calculated through 1000 Bootstraps"),
    x = "Estimate (95% Confidence Interval)",
    y = "Areas of social support and inclusion",
    color = "",
    caption = "* indicates a significant reduction in disparity due to social inclusion intervention"
  ) +
  scale_y_discrete(labels = c(
    "family"   = "Family Acceptance and Support",
    "school"   = "School Belonging",
    "friends"  = "Friendship Connections",
    "neigh"    = "Neighbourhood Cohesion",
    "religion" = "Religious Involvement",
    "social"   = "Overall Social Connection and Inclusion"
  )) +
 # scale_x_continuous(limits = c(0.1, 0.3), breaks = seq(0, 1.4, by = 0.1)) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.major.y = element_blank(),
    legend.position = "bottom",
    plot.title.position = "plot",   
    plot.title = element_text(hjust = 0.5, size = 14),
    plot.subtitle = element_text(hjust = 0.5, face = "italic", size = 12),
    axis.title.x = element_text(margin = margin(t = 12)),
    axis.title.y = element_text(margin = margin(r = 12)),
    plot.caption = element_text(hjust = -3, face = "italic", size = 10)
  )
```

### Table

```{r race results table}
results_race_clean <- results_race %>%
  mutate(Label = case_when(
    Race == "black" ~ "Black vs White",
    Race == "natam" ~ "Native American vs White",
    Race == "asian" ~ "Asian vs White")) %>%
  dplyr::select(Wave, Mediator, Label, `Effect Type` = Effect_Type, `Effect Estimate` = Mean, `CI Low` = CI_Low, `CI High` = CI_High)

results_race_clean # all confidence intervals included

results_race_all <- plot_race_data_ %>%
  mutate(`Percent difference` = (TCE - CDM) / TCE * 100) %>%
  dplyr::select(Wave, Mediator, Label = Race_Label, CDM, TCE, DIF, `CI Low` = CI_Low, `CI High` = CI_High, `Percent difference`)

results_race_all # dif confidence intervals and percentage decrease
```

***

# SES

## Descriptives

```{r frequency of ses}
freq(dat_pheno_W2$SES_cat)
freq(dat_pheno_W4$SES_cat)
```

```{r ses specific descriptives of mediators}
for (wave in names(waves)) {
  
  dat <- waves[[wave]]$data
  outcome_var <- waves[[wave]]$outcome
  
  for (m in mediators) {
    
    print(
      dat %>%
      group_by(SES_cat) %>%
        summarise(
          mediator = m,
          wave = wave,
          mean = mean(!!sym(m), na.rm = TRUE),
          sd   = sd(!!sym(m), na.rm = TRUE),
          min  = min(!!sym(m), na.rm = TRUE),
          max  = max(!!sym(m), na.rm = TRUE)
        ))
  }
}
```

## Correlations

SES ~ M
Y ~ M
Y ~ SES

```{r cor between m and y}
blue_shades <- c("#D0E1F9", "#A9C4EB", "#73A1D7", "#4178BE", "#0D47A1")

# loop over waves
for (wave in names(waves)) {
  
  dat <- waves[[wave]]$data
  outcome_var <- waves[[wave]]$outcome
  
  # M ~ X
  for (m in mediators) {
    p1 <- ggplot(dat, aes(x = SES, y = !!sym(m), color = as.factor(SES_cat))) +
      geom_point(alpha = 0.5) +
      geom_smooth(method = "lm", color = "black") +
      scale_color_manual(values = blue_shades) + 
      labs(
        title = paste0("Correlation between SES and social mediator: ", m),
        x = "SES",
        y = paste0("Social score: ", m)
      ) +
      theme_minimal() +
      theme(legend.position = "none")
  
    save_gg_cairo(p1, paste0("/home/thom1336/healthdis/figures/ses/SES_", m, "_cor.png"))
  }

  # Y ~ M
  for (m in mediators) {
    p2 <- ggplot(dat, aes(x = !!sym(m), y = !!sym(outcome_var), color = as.factor(SES_cat))) +
      geom_point(alpha = 0.5) +
      geom_smooth(method = "lm", color = "black") +
      scale_color_manual(values = blue_shades) + 
      labs(
        title = paste0("Correlation between ", outcome_var, " and social mediator: ", m),
        x = paste0("Social Score: ", m),
        y = outcome_var
      ) +
      theme_minimal() +
      theme(legend.position = "none")
  
    save_gg_cairo(p2, paste0("/home/thom1336/healthdis/figures/ses/", m, "_", outcome_var, "_cor.png"))
  }

  # Y ~ X
  p3 <- ggplot(dat, aes(x = SES, y = !!sym(outcome_var), color = as.factor(SES_cat))) +
      geom_point(alpha = 0.5) +
      geom_smooth(method = "lm", color = "black") +
      scale_color_manual(values = blue_shades) + 
      labs(
        title = paste0("Correlation between ", outcome_var, "and SES"),
        x = "SES",
        y = outcome_var
      ) +
      theme_minimal() +
      theme(legend.position = "none")
  
    save_gg_cairo(p1, paste0("/home/thom1336/healthdis/figures/ses/", outcome_var, "_SES_cor.png"))
}
```

## Disparity calculation

The below function will loop over W2 and W4 outcomes for all mediators: family, school, friends, neigh, religion, and social. 

In the variable naming, the first number refers to X and the second number to M.

* social_ses0 = the social variable (mediator) when ses = 0 (High SES)
* dep_00_social = the depression variable when ses = 0 AND social variable when ses = 0 (social_ses0)
* dep_10_social = the depression variable when ses = 1 AND social variable when ses = 0 (social_ses0). aka - the depression score for low SES people using what the social score would have been if they were high SES 
* dep_0 = total causal effect when ses = 0
* dep_1 = total causal effect when ses = 1

Terminology cross-over:
* DE = IDM-DE = CDM, Direct Effect = Interventional Disparity Measure - Direct Effect = Causal Disparity Measure 
* TCA = Adj-TA, Total Causal Association = Adjusted Total Association

Run the following on Rossmann:
*sbatch /home/thom1336/healthdis/bootstrap_ses.txt*

It will run the R script called bootstrap_ses.R which includes the following R code: 

```{r bootstrapping and montecarlo simluations for counterfactual calculation ses}
# library(purrr)
# library(tidyr)
# library(boot)
# library(tidyverse)
# library(dplyr)
# library(rlang)
# library(magrittr)
# 
# set.seed(123)
# remove(list = ls())
# 
# # load data
# load("/home/thom1336/healthdis/data/dat_pheno_W2.RData")
# load("/home/thom1336/healthdis/data/dat_pheno_W4.RData")
# 
# # list of mediators
# mediators <- c("family", "school", "friends", "neigh", "religion", "social")
# 
# # list of waves and their corresponding data and outcome names
# waves <- list(
#   W2 = list(data = dat_pheno_W2, outcome = "CESD_W2"),
#   W4 = list(data = dat_pheno_W4, outcome = "CESD_W4")
# )
# 
# # list of racial variables
# ses_vars <- c("SESlow", "SESmid") 
# 
# # function to run counterfactual calculations and Monte Carlo simulations within bootstrapping 
# bootstrap_stat <- function(data, indices, wave_name, mediators, ses_var) {
#   
#   #--------------------------------------------
#   # Bootstrap sample (original sample)
#   #--------------------------------------------
#   dat <- data[indices, ]
#   dat$original <- 1
#   dat$UM <- rnorm(nrow(dat))  # mediator error (original)
#   dat$UY <- rnorm(nrow(dat))  # outcome error (original)
#   
#   outcome_var <- waves[[wave_name]]$outcome
#   
#   #--------------------------------------------
#   # Monte Carlo expansion (inner loop)
#   #--------------------------------------------
#   dat_expanded <- dat[rep(1:nrow(dat), each = 1000), ]  
#   dat_expanded$original <- rep(c(1, rep(0, 999)), times = nrow(dat))
#   dat_expanded$UM <- rnorm(nrow(dat_expanded))
#   dat_expanded$UY <- rnorm(nrow(dat_expanded))
#   
#   #--------------------------------------------
#   # Counterfactual loop
#   #--------------------------------------------
#   
#   # create a list to store model results
#   model_list_reg <- list()
#   
#   #----------------------------------------------------
#   # Step 1: Variable for social (M) when ses_var = 0
#   #----------------------------------------------------
#   
#   for (m in mediators) {
#     # fit model
#     modelM <- lm(as.formula(paste(m, "~", ses_var)), data = dat)  # fit on original bootstrapped sample
#     
#     # store model in list
#     model_list_reg[[paste0("model_", m, "_", ses_var)]] <- modelM
#     
#     # extract intercept and residual SD
#     intercept <- coef(modelM)[["(Intercept)"]]
#     resid_sd <- summary(modelM)$sigma
#     
#     # simulate mediator under ses_var = 0 (on expanded)
#     new_var <- paste0(m, "_", ses_var, "0")
#     dat_expanded[[new_var]] <- intercept + resid_sd * dat_expanded$UM # applied to all expanded simulations
#     
#     print(summary(dat[[m]]))
#     print(summary(dat_expanded[[new_var]]))
#   }
#   
#   #------------------------------------
#   # Step 2: Model for Dep (Y)
#   #------------------------------------
#   
#   walk(mediators, function(m) {
#     # construct formula for the model
#     formula_str <- paste0(
#       outcome_var, " ~ ",
#       ses_var, " + ", 
#       m, " + ", 
#       m, ":", ses_var, " + ", 
#       m, "2 + ",
#       "H1GI1Y +", ses_var, ":H1GI1Y"
#     )
#     
#     formula_obj <- as.formula(formula_str)
#     modelY <- lm(formula_obj, data = dat)  # fit outcome model on original sample
#     model_nameY <- paste0("model_", outcome_var, "_", ses_var, "_", m)
#     assign(model_nameY, modelY, envir = .GlobalEnv)
#     
#     cat("\n--- Summary for", model_nameY, "---\n")
#     print(summary(modelY))
#   })
#   
#   #-----------------------------------------------------------------------
#   # Step 2A: Variable for Y, when ses_var = 0 and M=m_0, using model from Step 2 
#   #----------------------------------------------------------------------
#   
#   walk(mediators, function(m) {
#     model_obj <- get(paste0("model_", outcome_var, "_", ses_var, "_", m))
#     coefs <- coef(model_obj)
#     rmse <- summary(model_obj)$sigma
#     ses0_var <- sym(paste0(m, "_", ses_var, "0"))
#     output_var_00 <- sym(paste0(outcome_var, "_00_", m))
#     
#     dat_expanded <<- dat_expanded %>%  # apply prediction values to all expanded data sets
#       mutate(
#         !!output_var_00 :=
#           coefs[["(Intercept)"]] +                                        # intercept
#           (coefs[[ses_var]] %||% 0)           * 0 +                      # main effect of ses_var = 0
#           coefs[[m]]                        * !!ses0_var +               # main effect of mediator
#           (coefs[[paste0(ses_var, ":", m)]] %||% 0) * 0 +                # interaction of ses_var × mediator when ses_var = 0
#           coefs[[paste0(m, "2")]]           * (!!ses0_var)^2 +           # quadratic effect of mediator
#           (coefs[["H1GI1Y"]] %||% 0)        * H1GI1Y +                    # H1GI1Y main effect
#           (coefs[[paste0(ses_var, ":H1GI1Y")]] %||% 0)    * H1GI1Y * 0 + # interaction: ses_var × H1GI1Y when ses_var = 0
#           rmse * UY                                                       # residual
#       )
#     
#     cat("Created:", paste0(outcome_var, "_00_", m), "\n")
#   })
#   
#   #----------------------------------------------------------------------
#   # Step 2B: Variable for Y, when ses_var = 1 and M=m_0, using model from Step 2 
#   #----------------------------------------------------------------------
#   
#   walk(mediators, function(m) {
#     model_obj <- get(paste0("model_", outcome_var, "_", ses_var, "_", m))
#     coefs <- coef(model_obj)
#     rmse <- summary(model_obj)$sigma
#     
#     ses0_var   <- sym(paste0(m, "_", ses_var, "0"))
#     output_var_10 <- sym(paste0(outcome_var, "_10_", m))
#     
#     dat_expanded <<- dat_expanded %>%  # apply prediction values to all expanded data sets
#       mutate(
#         !!output_var_10 :=
#           coefs[["(Intercept)"]] +                                  # intercept
#           coefs[[ses_var]] +                                       # main effect of ses_var = 1
#           coefs[[m]]             * !!ses0_var +                    # main effect of mediator
#           coefs[[paste0(ses_var, ":", m)]] * !!ses0_var +         # interaction: ses_var × mediator
#           coefs[[paste0(m, "2")]] * (!!ses0_var)^2 +               # quadratic effect of mediator
#           coefs[["H1GI1Y"]]      * H1GI1Y +                         # H1GI1Y main effect
#           coefs[[paste0(ses_var, ":H1GI1Y")]]  * H1GI1Y +          # interaction: ses_var × H1GI1Y
#           rmse * UY                                                 # residual
#       )
#     
#     cat("Created:", paste0(outcome_var, "_10_", m), "\n")
#   })
#   
#   #----------------------------------------------------------------------  
#   # Step 3: Model for the Total Causal Effect (TCE), Y ~ X
#   #----------------------------------------------------------------------
#   
#   model <- lm(as.formula(paste0(outcome_var, " ~ ", ses_var, " + H1GI1Y +", ses_var, ":H1GI1Y")), 
#               data = dat) # computed on original data
#   
#   coefs <- coef(model)
#   
#   #----------------------------------------------------------------------
#   # Step 3A: Variables for Dep (Y), when ses_var = 0 (no mediator involved) 
#   #----------------------------------------------------------------------
#   
#   output_var_0 <- sym(paste0(outcome_var, "_0")) # when ses_var = 0
#   dat_expanded <- dat_expanded %>% # applied to expanded data
#     mutate(
#       !!output_var_0 :=
#         coefs["(Intercept)"] + 
#         (coefs[[ses_var]] %||% 0) * 0 + 
#         coefs["H1GI1Y"] * H1GI1Y +
#         coefs["sex:H1GI1Y"] * H1GI1Y * 0
#     )
#   
#   #----------------------------------------------------------------------
#   # Step 3B: Variables for Dep (Y), when ses_var = 1 (no mediator involved) 
#   #----------------------------------------------------------------------
#   
#   output_var_1 <- sym(paste0(outcome_var, "_1")) # when ses_var = 1
#   dat_expanded <- dat_expanded %>% # applied to expanded data
#     mutate(
#       !!output_var_1 :=
#         coefs["(Intercept)"] + 
#         coefs[[ses_var]] + 
#         coefs["H1GI1Y"] * H1GI1Y +
#         coefs["sex:H1GI1Y"] * H1GI1Y 
#     )
#   
#   cat("Created:", output_var_0, "\n")
#   cat("Created:", output_var_1, "\n")
#   
#   #--------------------------------------------
#   # Step 4: Compute differences: de, tce, dif
#   #--------------------------------------------
#   
#   walk(mediators, function(m) {
#     de_var <- sym(paste0("de_", ses_var, "_", m))
#     tce_var <- sym(paste0("tce_", ses_var, "_", m))
#     dif_var <- sym(paste0("dif_", ses_var, "_", m))
#     dep_00 <- sym(paste0(outcome_var, "_00_", m))
#     dep_10 <- sym(paste0(outcome_var, "_10_", m))
#     dep_0  <- sym(paste0(outcome_var, "_0"))
#     dep_1  <- sym(paste0(outcome_var, "_1"))
#     
#     dat_expanded <<- dat_expanded %>% # calculated for each expanded dataset
#       mutate(
#         !!de_var := !!dep_10 - !!dep_00,
#         !!tce_var := !!dep_1 - !!dep_0,
#         !!dif_var := !!tce_var - !!de_var
#       )
#   })
#   
#   #-----------------------------------------------------------------
#   # Calulate mean de, tce, and dif across all expanded data sets
#   #-----------------------------------------------------------------
#   
#   effects <- map(mediators, function(m) {
#     c(
#       CDM = mean(dat_expanded[[paste0("de_", ses_var, "_", m)]], na.rm = TRUE),
#       TCE = mean(dat_expanded[[paste0("tce_", ses_var, "_", m)]], na.rm = TRUE),
#       DIF = mean(dat_expanded[[paste0("dif_", ses_var, "_", m)]], na.rm = TRUE)
#     )
#   })
#   
#   names_list <- unlist(map2(mediators, seq_along(mediators),
#                             ~ c(paste0("CDM", .y), paste0("TCE", .y), paste0("DIF", .y))))
#   out <- unlist(effects)
#   names(out) <- names_list
#   return(out)
# }
# 
# #----------------------------------
# # Run Bootstrapping (outer loop)
# #----------------------------------
# 
# for (wave in names(waves)) {
#   for (ses_var in ses_vars) {  # NEW LINE: Nested loop over each ses variable
#     cat("\nBootstrapping wave:", wave, "for ses variable:", ses_var, "\n")
#     
#     # This re-samples individuals 1000 times to capture sampling variability and calculate confidence intervals 
#     boot_results <- boot(
#       data = waves[[wave]]$data,
#       statistic = function(d, i) bootstrap_stat(d, i, wave_name = wave, mediators = mediators, ses_var = ses_var), # loops through ses_var
#       R = 1000
#     )
#     
#     estimates <- boot_results$t
#     col_names <- names(boot_results$t0)
#     
#     # Calculate mean, SE, and percentile confidence intervals
#     results <- tibble(
#       Effect  = col_names,
#       Mean    = boot_results$t0,
#       SE      = apply(estimates, 2, sd, na.rm = TRUE),
#       CI_Low  = apply(estimates, 2, quantile, probs = 0.025, na.rm = TRUE),
#       CI_High = apply(estimates, 2, quantile, probs = 0.975, na.rm = TRUE),
#       Wave    = wave,
#       ses    = ses_var  # Add the ses variable to the results
#     ) %>%
#       # Extract mediator number and effect type (CDM/TCE/DIF)
#       mutate(
#         Mediator_Num = as.numeric(gsub("[^0-9]", "", Effect)),
#         Effect_Type  = gsub("[0-9]", "", Effect),
#         Mediator     = mediators[Mediator_Num],
#         Wave         = wave
#       ) %>%
#       dplyr::select(Wave, ses, Mediator, Effect_Type, Mean, SE, CI_Low, CI_High) # final table
#     
#     saveRDS(results, file = paste0("/home/thom1336/healthdis/data/ses/bootstrap_results_", wave, "_", ses_var, ".rds"))
#     saveRDS(boot_results, file = paste0("/home/thom1336/healthdis/data/ses/boot_object_", wave, "_", ses_var, ".rds"))
#     
#     cat("Saved results for wave:", wave, "and ses variable:", ses_var, "\n")
#   }
# }
```

## Results

* DE / IDM-DE / CDM estimates the disparity that remains after intervening on the mediator (social connection), i.e. the remaining association between SES and depression symptoms if everyone had their social connection level shifted to match that of high SES people
* TCE / Adj-TA is the total association between SES and depression, after adjusting for covariates.
* DIF reflects the potential mitigation due to intervening on social support and inclusion. Larger differences between Adj-TA and IDM-DE suggest greater scope for intervention.

```{r read in results files}
# Wave 2
results_seslow_W2 <- readRDS("/home/thom1336/healthdis/data/ses/bootstrap_results_W2_SESlow.rds")
results_sesmid_W2 <- readRDS("/home/thom1336/healthdis/data/ses/bootstrap_results_W2_SESmid.rds")

# Wave 4
results_seslow_W4 <- readRDS("/home/thom1336/healthdis/data/ses/bootstrap_results_W4_SESlow.rds")
results_sesmid_W4 <- readRDS("/home/thom1336/healthdis/data/ses/bootstrap_results_W4_SESmid.rds")

results_ses <- rbind(results_seslow_W2, results_sesmid_W2,
                     results_seslow_W4, results_sesmid_W4)
results_ses
```

### Plot

Here, dep_1 and dep_0 are the same across mediators because they come from the total effect model (Y ~ ses + H1GI1Y), which does not include the mediator.

```{r plot ses effects}
plot_ses_data_ <- results_ses %>%
  filter(Effect_Type %in% c("CDM", "TCE")) %>%
  dplyr::select(Mediator, ses, Wave, Effect_Type, Mean) %>%
  pivot_wider(names_from = Effect_Type, values_from = Mean) %>%
  left_join(
    results_ses %>% 
      filter(Effect_Type == "DIF") %>%
      dplyr::select(Mediator, ses, Wave, DIF = Mean, CI_Low, CI_High), # confidence intervals are for DIF
    by = c("Mediator", "Wave", "ses")
  ) %>%
  mutate(
    sig = if_else(CI_Low > 0 | CI_High < 0, TRUE, FALSE),
    Mediator = factor(Mediator, levels = rev(mediators)),
    Wave_Label = factor(Wave, levels = c("W2", "W4"), labels = c("Wave 2", "Wave 4")),
    y_adj = as.numeric(Mediator) + if_else(Wave_Label == "Wave 4", -0.4, 0),
    ses_Label = factor(recode(as.character(ses),
    "SESlow" = "Low SES vs High",
    "SESmid" = "Middle SES vs High"), 
    levels = c("Middle SES vs High", "Low SES vs High"))
  )

facet_limits <- tibble::tibble(
  ses_Label = factor(c(
    "Low SES vs High", 
    "Middle SES vs High"
  ), levels = levels(plot_ses_data_$ses_Label)),
  x_min = c(0.22, 0),
  x_max = c(0.38, 0.2)
)

plot_ses_data_ <- plot_ses_data_ %>%
  left_join(facet_limits, by = "ses_Label")

plot_ses <- ggplot(plot_ses_data_, aes(y = Mediator)) +
  # Dumbbell lines
  geom_segment(aes(x = CDM, xend = TCE, y = y_adj, yend = y_adj, color = Wave_Label), linewidth = 1) +
  
  # CDM points (mapped to shape)
  geom_point(aes(x = CDM, y = y_adj, color = Wave_Label, shape = "CDM"), size = 3) +
  
  # TCE points (mapped to shape)
  geom_point(aes(x = TCE, y = y_adj, color = Wave_Label, shape = "TCE"), size = 3) +
  
  # Difference labels
  geom_text(aes(x = (CDM + TCE) / 2, y = y_adj, label = paste0("Δ ", round(DIF, 3))),
          vjust = -1, size = 5) +

  # Significance stars
  geom_text(
  data = plot_ses_data_ %>% filter(sig),
  aes(x = (CDM + TCE) / 2, y = y_adj, label = "*"),
  vjust = 1.5, size = 6, color = "black", inherit.aes = FALSE) +
  
  facet_grid(~ses_Label, scales = "free_x") +

  scale_x_continuous(
  breaks = seq(0, 0.4, by = 0.1),           # where the labels go
  minor_breaks = seq(0, 0.4, by = 0.05)     # extra gridlines
  ) +
  
  geom_blank(aes(x = x_min)) +
  geom_blank(aes(x = x_max)) +
  
  geom_vline(
    data = data.frame(
      ses_Label = factor(
        "Middle SES vs High",
        levels = levels(plot_ses_data_$ses_Label)  # keep original order
      )
    ),
    aes(xintercept = 0),
    linetype = "dashed",
    color = "grey",
    linewidth = 0.5
  ) +

  scale_color_manual(values = c("Wave 2" = "#0D0887", "Wave 4" = "#CC4678")) +
  scale_shape_manual(
    name = "",
    values = c("CDM" = 16, "TCE" = 17), # Circle for CDM, triangle for TCE
    labels = c("Association after intervention (CDM)", "Total causal association (TCE)")
  ) +
  
  labs(
    title = "Association between SES and depression symptoms across if we intervened on social support and inclusion",
    subtitle = paste0("W2 N = ", nrow(dat_pheno_W2), "; W4 N = ", nrow(dat_pheno_W4), "; Reference group = High SES families",
                      " \n1000 Monte Carlo expansions and Confidence Intervals calculated through 1000 Bootstraps"),
    x = "Estimate (95% Confidence Interval)",
    y = "Areas of social support and inclusion",
    color = "",
    caption = "* indicates a significant reduction in disparity due to social inclusion intervention"
  ) +
  scale_y_discrete(labels = c(
    "family"   = "Family Acceptance and Support",
    "school"   = "School Belonging",
    "friends"  = "Friendship Connections",
    "neigh"    = "Neighbourhood Cohesion",
    "religion" = "Religious Involvement",
    "social"   = "Overall Social Connection and Inclusion"
  )) +
 # scale_x_continuous(limits = c(0.1, 0.3), breaks = seq(0, 1.4, by = 0.1)) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.major.y = element_blank(),
    legend.position = "bottom",
    plot.title.position = "plot",   
    plot.title = element_text(hjust = 0.5, size = 14),
    plot.subtitle = element_text(hjust = 0.5, face = "italic", size = 12),
    axis.title.x = element_text(margin = margin(t = 12)),
    axis.title.y = element_text(margin = margin(r = 12)),
    plot.caption = element_text(hjust = -1.4, face = "italic", size = 10)
  )

save_gg_cairo(plot_ses, "/home/thom1336/healthdis/figures/ses/results_ses.png", width = 1000, height = 650)
```

### Table 

```{r ses results table}
results_ses_clean <- results_ses %>%
  mutate(Label = case_when(
    ses == "SESlow" ~ "Low SES vs High",
    ses == "SESmid" ~ "Middle SES vs High")) %>%
  dplyr::select(Wave, Mediator, Label, `Effect Type` = Effect_Type, `Effect Estimate` = Mean, `CI Low` = CI_Low, `CI High` = CI_High)

results_ses_clean # all confidence intervals included

results_ses_all <- plot_ses_data_ %>%
  mutate(`Percent difference` = (TCE - CDM) / TCE * 100) %>%
  dplyr::select(Wave, Mediator, Label = ses_Label, CDM, TCE, DIF, `CI Low` = CI_Low, `CI High` = CI_High, `Percent difference`)

results_ses_all # dif confidence intervals and percentage decrease
```

***

# PGS

## Descriptives

```{r frequency of ogs}
freq(dat_pheno_pgs_W2$pgs_cat)
freq(dat_pheno_pgs_W4$pgs_cat)
```

```{r pgs specific descriptives of mediators}
for (wave in names(waves_pgs)) {
  
  dat <- waves_pgs[[wave]]$data
  outcome_var <- waves_pgs[[wave]]$outcome
  
  for (m in mediators) {
    
    print(
      dat %>%
      group_by(pgs_cat) %>%
        summarise(
          mediator = m,
          wave = wave,
          mean = mean(!!sym(m), na.rm = TRUE),
          sd   = sd(!!sym(m), na.rm = TRUE),
          min  = min(!!sym(m), na.rm = TRUE),
          max  = max(!!sym(m), na.rm = TRUE)
        ))
  }
}
```

## Correlations

SES ~ M
Y ~ M
Y ~ SES

```{r cor between m and y}
blue_shades <- c("#D0E1F9", "#A9C4EB", "#73A1D7", "#4178BE", "#0D47A1")

# loop over waves
for (wave in names(waves_pgs)) {
  
  dat <- waves_pgs[[wave]]$data
  outcome_var <- waves_pgs[[wave]]$outcome
  
  # M ~ X
  for (m in mediators) {
    p1 <- ggplot(dat, aes(x = pgs, y = !!sym(m), color = as.factor(pgs_cat))) +
      geom_point(alpha = 0.5) +
      geom_smooth(method = "lm", color = "black") +
      scale_color_manual(values = blue_shades) + 
      labs(
        title = paste0("Correlation between PGS and social mediator: ", m),
        x = "PGS",
        y = paste0("Social score: ", m)
      ) +
      theme_minimal() +
      theme(legend.position = "none")
  
    save_gg_cairo(p1, paste0("/home/thom1336/healthdis/figures/pgs/PGS_", m, "_cor.png"))
  }

  # Y ~ M
  for (m in mediators) {
    p2 <- ggplot(dat, aes(x = !!sym(m), y = !!sym(outcome_var), color = as.factor(pgs_cat))) +
      geom_point(alpha = 0.5) +
      geom_smooth(method = "lm", color = "black") +
      scale_color_manual(values = blue_shades) + 
      labs(
        title = paste0("Correlation between ", outcome_var, " and social mediator: ", m),
        x = paste0("Social Score: ", m),
        y = outcome_var
      ) +
      theme_minimal() +
      theme(legend.position = "none")
  
    save_gg_cairo(p2, paste0("/home/thom1336/healthdis/figures/pgs/", m, "_", outcome_var, "_cor.png"))
  }

  # Y ~ X
  p3 <- ggplot(dat, aes(x = pgs, y = !!sym(outcome_var), color = as.factor(pgs_cat))) +
      geom_point(alpha = 0.5) +
      geom_smooth(method = "lm", color = "black") +
      scale_color_manual(values = blue_shades) + 
      labs(
        title = paste0("Correlation between ", outcome_var, "and PGS"),
        x = "PGS",
        y = outcome_var
      ) +
      theme_minimal() +
      theme(legend.position = "none")
  
    save_gg_cairo(p1, paste0("/home/thom1336/healthdis/figures/pgs/", outcome_var, "_pgs_cor.png"))
}
```

## PGS prediction 

```{r check PRS prediction}
# continuous pgs 
pgs_W2_cont_model <- lm(CESD_W2 ~ pgs, dat_pheno_pgs_W2)
summary(pgs_W2_cont_model) # Beta = 0.31186; R2 = 0.01348
pgs_W4_cont_model <- lm(CESD_W4 ~ pgs, dat_pheno_pgs_W4)
summary(pgs_W4_cont_model) # Beta = 0.298510; R2 = 0.012 

# categorical pgs 
pgs_W2_cat_model <- lm(CESD_W2 ~ as.factor(pgs_cat), dat_pheno_pgs_W2)
summary(pgs_W2_cat_model) # Beta (pgs3) = 0.23841; R2 = 0.009349
pgs_W4_cat_model <- lm(CESD_W4 ~ as.factor(pgs_cat), dat_pheno_pgs_W4)
summary(pgs_W4_cat_model) # Beta (pgs3) = 0.25589; R2 = 0.0107
```

## Disparity calculation

The below function will loop over W2 and W4 outcomes for all mediators: family, school, friends, neigh, religion, and social. 

In the variable naming, the first number refers to X and the second number to M.

* social_pgs0 = the social variable (mediator) when pgs = 0 (lowest pgs)
* dep_00_social = the depression variable when pgs = 0 AND social variable when pgs = 0 (social_pgs0)
* dep_10_social = the depression variable when pgs = 1 AND social variable when pgs = 0 (social_pgs0). aka - the depression score for high pgs people using what the social score would have been if they were lowest pgs 
* dep_0 = total causal effect when pgs = 0
* dep_1 = total causal effect when pgs = 1

Terminology cross-over:
* DE = IDM-DE = CDM, Direct Effect = Interventional Disparity Measure - Direct Effect = Causal Disparity Measure 
* TCA = Adj-TA, Total Causal Association = Adjusted Total Association

Run the following on Rossmann:
*sbatch /home/thom1336/healthdis/bootstrap_pgs.txt*

It will run the R script called bootstrap_ses.R which includes the following R code: 

```{r bootstrapping and montecarlo simluations for counterfactual calculation pgs}
# library(purrr)
# library(tidyr)
# library(boot)
# library(tidyverse)
# library(dplyr)
# library(rlang)
# library(magrittr)
# 
# set.seed(123)
# remove(list = ls())
# 
# # load data
# load("/home/thom1336/healthdis/data/dat_pheno_W2.RData")
# load("/home/thom1336/healthdis/data/dat_pheno_W4.RData")
# 
# # list of mediators
# mediators <- c("family", "school", "friends", "neigh", "religion", "social")
# 
# # list of waves and their corresponding data and outcome names
# waves <- list(
#   W2 = list(data = dat_pheno_W2, outcome = "CESD_W2"),
#   W4 = list(data = dat_pheno_W4, outcome = "CESD_W4")
# )
# 
# # list of pgs variables
# pgs_vars <- c("pgs_reg2", "pgs_reg3") 
# 
# # function to run counterfactual calculations and Monte Carlo simulations within bootstrapping 
# bootstrap_stat <- function(data, indices, wave_name, mediators, pgs_var) {
#   
#   #--------------------------------------------
#   # Bootstrap sample (original sample)
#   #--------------------------------------------
#   dat <- data[indices, ]
#   dat$original <- 1
#   dat$UM <- rnorm(nrow(dat))  # mediator error (original)
#   dat$UY <- rnorm(nrow(dat))  # outcome error (original)
#   
#   outcome_var <- waves[[wave_name]]$outcome
#   
#   #--------------------------------------------
#   # Monte Carlo expansion (inner loop)
#   #--------------------------------------------
#   dat_expanded <- dat[rep(1:nrow(dat), each = 1000), ]  
#   dat_expanded$original <- rep(c(1, rep(0, 999)), times = nrow(dat))
#   dat_expanded$UM <- rnorm(nrow(dat_expanded))
#   dat_expanded$UY <- rnorm(nrow(dat_expanded))
#   
#   #--------------------------------------------
#   # Counterfactual loop
#   #--------------------------------------------
#   
#   # create a list to store model results
#   model_list_reg <- list()
#   
#   #----------------------------------------------------
#   # Step 1: Variable for social (M) when pgs_var = 0
#   #----------------------------------------------------
#   
#   for (m in mediators) {
#     # fit model
#     modelM <- lm(as.formula(paste(m, "~", pgs_var)), data = dat)  # fit on original bootstrapped sample
#     
#     # store model in list
#     model_list_reg[[paste0("model_", m, "_", pgs_var)]] <- modelM
#     
#     # extract intercept and residual SD
#     intercept <- coef(modelM)[["(Intercept)"]]
#     resid_sd <- summary(modelM)$sigma
#     
#     # simulate mediator under pgs_var = 0 (on expanded)
#     new_var <- paste0(m, "_", pgs_var, "0")
#     dat_expanded[[new_var]] <- intercept + resid_sd * dat_expanded$UM # applied to all expanded simulations
#     
#     print(summary(dat[[m]]))
#     print(summary(dat_expanded[[new_var]]))
#   }
#   
#   #------------------------------------
#   # Step 2: Model for Dep (Y)
#   #------------------------------------
#   
#   walk(mediators, function(m) {
#     # construct formula for the model
#     formula_str <- paste0(
#       outcome_var, " ~ ",
#       pgs_var, " + ", 
#       m, " + ", 
#       m, ":", pgs_var, " + ", 
#       m, "2 + ",
#       "H1GI1Y +", pgs_var, ":H1GI1Y"
#     )
#     
#     formula_obj <- as.formula(formula_str)
#     modelY <- lm(formula_obj, data = dat)  # fit outcome model on original sample
#     model_nameY <- paste0("model_", outcome_var, "_", pgs_var, "_", m)
#     assign(model_nameY, modelY, envir = .GlobalEnv)
#     
#     cat("\n--- Summary for", model_nameY, "---\n")
#     print(summary(modelY))
#   })
#   
#   #-----------------------------------------------------------------------
#   # Step 2A: Variable for Y, when pgs_var = 0 and M=m_0, using model from Step 2 
#   #----------------------------------------------------------------------
#   
#   walk(mediators, function(m) {
#     model_obj <- get(paste0("model_", outcome_var, "_", pgs_var, "_", m))
#     coefs <- coef(model_obj)
#     rmse <- summary(model_obj)$sigma
#     pgs0_var <- sym(paste0(m, "_", pgs_var, "0"))
#     output_var_00 <- sym(paste0(outcome_var, "_00_", m))
#     
#     dat_expanded <<- dat_expanded %>%  # apply prediction values to all expanded data sets
#       mutate(
#         !!output_var_00 :=
#           coefs[["(Intercept)"]] +                                        # intercept
#           (coefs[[pgs_var]] %||% 0)           * 0 +                      # main effect of pgs_var = 0
#           coefs[[m]]                        * !!pgs0_var +               # main effect of mediator
#           (coefs[[paste0(pgs_var, ":", m)]] %||% 0) * 0 +                # interaction of pgs_var × mediator when pgs_var = 0
#           coefs[[paste0(m, "2")]]           * (!!pgs0_var)^2 +           # quadratic effect of mediator
#           (coefs[["H1GI1Y"]] %||% 0)        * H1GI1Y +                    # H1GI1Y main effect
#           (coefs[[paste0(pgs_var, ":H1GI1Y")]] %||% 0)    * H1GI1Y * 0 + # interaction: pgs_var × H1GI1Y when pgs_var = 0
#           rmse * UY                                                       # residual
#       )
#     
#     cat("Created:", paste0(outcome_var, "_00_", m), "\n")
#   })
#   
#   #----------------------------------------------------------------------
#   # Step 2B: Variable for Y, when pgs_var = 1 and M=m_0, using model from Step 2 
#   #----------------------------------------------------------------------
#   
#   walk(mediators, function(m) {
#     model_obj <- get(paste0("model_", outcome_var, "_", pgs_var, "_", m))
#     coefs <- coef(model_obj)
#     rmse <- summary(model_obj)$sigma
#     
#     pgs0_var   <- sym(paste0(m, "_", pgs_var, "0"))
#     output_var_10 <- sym(paste0(outcome_var, "_10_", m))
#     
#     dat_expanded <<- dat_expanded %>%  # apply prediction values to all expanded data sets
#       mutate(
#         !!output_var_10 :=
#           coefs[["(Intercept)"]] +                                  # intercept
#           coefs[[pgs_var]] +                                       # main effect of pgs_var = 1
#           coefs[[m]]             * !!pgs0_var +                    # main effect of mediator
#           coefs[[paste0(pgs_var, ":", m)]] * !!pgs0_var +         # interaction: pgs_var × mediator
#           coefs[[paste0(m, "2")]] * (!!pgs0_var)^2 +               # quadratic effect of mediator
#           coefs[["H1GI1Y"]]      * H1GI1Y +                         # H1GI1Y main effect
#           coefs[[paste0(pgs_var, ":H1GI1Y")]]  * H1GI1Y +          # interaction: pgs_var × H1GI1Y
#           rmse * UY                                                 # residual
#       )
#     
#     cat("Created:", paste0(outcome_var, "_10_", m), "\n")
#   })
#   
#   #----------------------------------------------------------------------  
#   # Step 3: Model for the Total Causal Effect (TCE), Y ~ X
#   #----------------------------------------------------------------------
#   
#   model <- lm(as.formula(paste0(outcome_var, " ~ ", pgs_var, " + H1GI1Y +", pgs_var, ":H1GI1Y")), 
#               data = dat) # computed on original data
#   
#   coefs <- coef(model)
#   
#   #----------------------------------------------------------------------
#   # Step 3A: Variables for Dep (Y), when pgs_var = 0 (no mediator involved) 
#   #----------------------------------------------------------------------
#   
#   output_var_0 <- sym(paste0(outcome_var, "_0")) # when pgs_var = 0
#   dat_expanded <- dat_expanded %>% # applied to expanded data
#     mutate(
#       !!output_var_0 :=
#         coefs["(Intercept)"] + 
#         (coefs[[pgs_var]] %||% 0) * 0 + 
#         coefs["H1GI1Y"] * H1GI1Y +
#         (coefs[[paste0(pgs_var, ":H1GI1Y")]]) * H1GI1Y * 0
#     )
#   
#   #----------------------------------------------------------------------
#   # Step 3B: Variables for Dep (Y), when pgs_var = 1 (no mediator involved) 
#   #----------------------------------------------------------------------
#   
#   output_var_1 <- sym(paste0(outcome_var, "_1")) # when pgs_var = 1
#   dat_expanded <- dat_expanded %>% # applied to expanded data
#     mutate(
#       !!output_var_1 :=
#         coefs["(Intercept)"] + 
#         coefs[[pgs_var]] + 
#         coefs["H1GI1Y"] * H1GI1Y +
#         (coefs[[paste0(pgs_var, ":H1GI1Y")]])  * H1GI1Y 
#     )
#   
#   cat("Created:", output_var_0, "\n")
#   cat("Created:", output_var_1, "\n")
#   
#   #--------------------------------------------
#   # Step 4: Compute differences: de, tce, dif
#   #--------------------------------------------
#   
#   walk(mediators, function(m) {
#     de_var <- sym(paste0("de_", pgs_var, "_", m))
#     tce_var <- sym(paste0("tce_", pgs_var, "_", m))
#     dif_var <- sym(paste0("dif_", pgs_var, "_", m))
#     dep_00 <- sym(paste0(outcome_var, "_00_", m))
#     dep_10 <- sym(paste0(outcome_var, "_10_", m))
#     dep_0  <- sym(paste0(outcome_var, "_0"))
#     dep_1  <- sym(paste0(outcome_var, "_1"))
#     
#     dat_expanded <<- dat_expanded %>% # calculated for each expanded dataset
#       mutate(
#         !!de_var := !!dep_10 - !!dep_00,
#         !!tce_var := !!dep_1 - !!dep_0,
#         !!dif_var := !!tce_var - !!de_var
#       )
#   })
#   
#   #-----------------------------------------------------------------
#   # Calulate mean de, tce, and dif across all expanded data sets
#   #-----------------------------------------------------------------
#   
#   effects <- map(mediators, function(m) {
#     c(
#       CDM = mean(dat_expanded[[paste0("de_", pgs_var, "_", m)]], na.rm = TRUE),
#       TCE = mean(dat_expanded[[paste0("tce_", pgs_var, "_", m)]], na.rm = TRUE),
#       DIF = mean(dat_expanded[[paste0("dif_", pgs_var, "_", m)]], na.rm = TRUE)
#     )
#   })
#   
#   names_list <- unlist(map2(mediators, seq_along(mediators),
#                             ~ c(paste0("CDM", .y), paste0("TCE", .y), paste0("DIF", .y))))
#   out <- unlist(effects)
#   names(out) <- names_list
#   return(out)
# }
# 
# #----------------------------------
# # Run Bootstrapping (outer loop)
# #----------------------------------
# 
# for (wave in names(waves)) {
#   for (pgs_var in pgs_vars) {  # NEW LINE: Nested loop over each pgs variable
#     cat("\nBootstrapping wave:", wave, "for pgs variable:", pgs_var, "\n")
#     
#     # This re-samples individuals 1000 times to capture sampling variability and calculate confidence intervals 
#     boot_results <- boot(
#       data = waves[[wave]]$data,
#       statistic = function(d, i) bootstrap_stat(d, i, wave_name = wave, mediators = mediators, pgs_var = pgs_var), # loops through pgs_var
#       R = 1000
#     )
#     
#     estimates <- boot_results$t
#     col_names <- names(boot_results$t0)
#     
#     # Calculate mean, SE, and percentile confidence intervals
#     results <- tibble(
#       Effect  = col_names,
#       Mean    = boot_results$t0,
#       SE      = apply(estimates, 2, sd, na.rm = TRUE),
#       CI_Low  = apply(estimates, 2, quantile, probs = 0.025, na.rm = TRUE),
#       CI_High = apply(estimates, 2, quantile, probs = 0.975, na.rm = TRUE),
#       Wave    = wave,
#       pgs    = pgs_var  # Add the pgs variable to the results
#     ) %>%
#       # Extract mediator number and effect type (CDM/TCE/DIF)
#       mutate(
#         Mediator_Num = as.numeric(gsub("[^0-9]", "", Effect)),
#         Effect_Type  = gsub("[0-9]", "", Effect),
#         Mediator     = mediators[Mediator_Num],
#         Wave         = wave
#       ) %>%
#       dplyr::select(Wave, pgs, Mediator, Effect_Type, Mean, SE, CI_Low, CI_High) # final table
#     
#     saveRDS(results, file = paste0("/home/thom1336/healthdis/data/pgs/bootstrap_results_ALL_", wave, "_", pgs_var, ".rds"))
#     saveRDS(boot_results, file = paste0("/home/thom1336/healthdis/data/pgs/boot_object_ALL_", wave, "_", pgs_var, ".rds"))
#     
#     cat("Saved results for wave:", wave, "and pgs variable:", pgs_var, "\n")
#   }
# }
```

## Results

* DE / IDM-DE / CDM estimates the disparity that remains after intervening on the mediator (social connection), i.e. the remaining association between pgs and depression symptoms if everyone had their social connection level shifted to match that of lowest pgs people
* TCE / Adj-TA is the total association between pgs and depression, after adjusting for covariates.
* DIF reflects the potential mitigation due to intervening on social support and inclusion. Larger differences between Adj-TA and IDM-DE suggest greater scope for intervention.

These results are using PGS in the entire sample that have had ancestry-specific PCs regressed out. 

```{r read in results files eur}
# Wave 2
results_ALL_pgs2_W2 <- readRDS("/home/thom1336/healthdis/data/pgs/bootstrap_results_ALL_W2_pgs_reg2.rds")
results_ALL_pgs3_W2 <- readRDS("/home/thom1336/healthdis/data/pgs/bootstrap_results_ALL_W2_pgs_reg3.rds")

# Wave 4
results_ALL_pgs2_W4 <- readRDS("/home/thom1336/healthdis/data/pgs/bootstrap_results_ALL_W4_pgs_reg2.rds")
results_ALL_pgs3_W4 <- readRDS("/home/thom1336/healthdis/data/pgs/bootstrap_results_ALL_W4_pgs_reg3.rds")

results_ALL_pgs <- rbind(results_ALL_pgs2_W2, results_ALL_pgs3_W2, 
                         results_ALL_pgs2_W4, results_ALL_pgs3_W4)
results_ALL_pgs
```

## Plot

Here, dep_1 and dep_0 are the same across mediators because they come from the total effect model (Y ~ ses + H1GI1Y), which does not include the mediator.

```{r plot ALL pgs effects}
plot_ALL_pgs_data <- results_ALL_pgs %>%
  filter(Effect_Type %in% c("CDM", "TCE")) %>%
  dplyr::select(Mediator, pgs, Wave, Effect_Type, Mean) %>%
  pivot_wider(names_from = Effect_Type, values_from = Mean) %>%
  left_join(
    results_ALL_pgs %>% 
      filter(Effect_Type == "DIF") %>%
      dplyr::select(Mediator, pgs, Wave, DIF = Mean, CI_Low, CI_High), # confidence intervals are for DIF
    by = c("Mediator", "Wave", "pgs")
  ) %>%
  mutate(
    sig = if_else(CI_Low > 0 | CI_High < 0, TRUE, FALSE),
    Mediator = factor(Mediator, levels = rev(mediators)),
    Wave_Label = factor(Wave, levels = c("W2", "W4"), labels = c("Wave 2", "Wave 4")),
    y_adj = as.numeric(Mediator) + if_else(Wave_Label == "Wave 4", -0.4, 0),
    pgs_Label = factor(recode(as.character(pgs),
    "pgs_reg2" = "Middle PGS vs Low",
    "pgs_reg3" = "High PGS vs Low"), 
    levels = c("Middle PGS vs Low", "High PGS vs Low"))
  )

facet_limits <- tibble::tibble(
  pgs_Label = factor(c(
    "Middle PGS vs Low", 
    "High PGS vs Low"
  ), levels = levels(plot_ALL_pgs_data$pgs_Label)),
  x_min = c(0, 0.20),
  x_max = c(0.15, 0.34)
)

plot_ALL_pgs_data <- plot_ALL_pgs_data %>%
  left_join(facet_limits, by = "pgs_Label")

plot_pgs_ALL <- ggplot(plot_ALL_pgs_data, aes(y = Mediator)) +
  # Dumbbell lines
  geom_segment(aes(x = CDM, xend = TCE, y = y_adj, yend = y_adj, color = Wave_Label), linewidth = 1) +
  
  # CDM points (mapped to shape)
  geom_point(aes(x = CDM, y = y_adj, color = Wave_Label, shape = "CDM"), size = 3) +
  
  # TCE points (mapped to shape)
  geom_point(aes(x = TCE, y = y_adj, color = Wave_Label, shape = "TCE"), size = 3) +
  
  # Difference labels
  geom_text(aes(x = (CDM + TCE) / 2, y = y_adj, label = paste0("Δ ", round(DIF, 3))),
          vjust = -1, size = 5) +

  # Significance stars
  geom_text(
  data = plot_ALL_pgs_data %>% filter(sig),
  aes(x = (CDM + TCE) / 2, y = y_adj, label = "*"),
  vjust = 1.5, size = 6, color = "black", inherit.aes = FALSE) +
  
  facet_grid(~pgs_Label, scales = "free_x") +
  
  geom_blank(aes(x = x_min)) +
  geom_blank(aes(x = x_max)) +
  
  scale_x_continuous(
  breaks = seq(0, 0.4, by = 0.1),           # where the labels go
  minor_breaks = seq(0, 0.4, by = 0.05)     # extra gridlines
  ) +
  
  geom_vline(
    data = data.frame(
      pgs_Label = factor(
        "Middle PGS vs Low",
        levels = levels(plot_ALL_pgs_data$pgs_Label)  # keep original order
      )
    ),
    aes(xintercept = 0),
    linetype = "dashed",
    color = "grey",
    linewidth = 0.5
  ) +

  scale_color_manual(values = c("Wave 2" = "#0D0887", "Wave 4" = "#CC4678")) +
  scale_shape_manual(
    name = "",
    values = c("CDM" = 16, "TCE" = 17), # Circle for CDM, triangle for TCE
    labels = c("Association after intervention (CDM)", "Total causal association (TCE)")
  ) +
  
  labs(
    title = "Association between PGS and depression symptoms if we intervened on social support and inclusion",
    subtitle = paste0("W2 N = ", nrow(dat_pheno_pgs_W2), "; W4 N = ", nrow(dat_pheno_pgs_W4), "; Reference group = Low PGS",
                      " \n1000 Monte Carlo expansions and Confidence Intervals calculated through 1000 Bootstraps"),
    x = "Estimate (95% Confidence Interval)",
    y = "Areas of social support and inclusion",
    color = "",
    caption = "* indicates a significant reduction in disparity due to social inclusion intervention"
  ) +
  scale_y_discrete(labels = c(
    "family"   = "Family Acceptance and Support",
    "school"   = "School Belonging",
    "friends"  = "Friendship Connections",
    "neigh"    = "Neighbourhood Cohesion",
    "religion" = "Religious Involvement",
    "social"   = "Overall Social Connection and Inclusion"
  )) +
 # scale_x_continuous(limits = c(0.1, 0.3), breaks = seq(0, 1.4, by = 0.1)) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.major.y = element_blank(),
    legend.position = "bottom",
    plot.title.position = "plot",   
    plot.title = element_text(hjust = 0.5, size = 14),
    plot.subtitle = element_text(hjust = 0.5, face = "italic", size = 12),
    axis.title.x = element_text(margin = margin(t = 12)),
    axis.title.y = element_text(margin = margin(r = 12)),
    plot.caption = element_text(hjust = -1.4, face = "italic", size = 10)
  )

save_gg_cairo(plot_pgs_ALL, "/home/thom1336/healthdis/figures/pgs/results_pgs_ALL.png", width = 1000, height = 650)
```

### Table 

```{r pgs results table}
results_pgs_clean <- results_ALL_pgs %>%
  mutate(Label = case_when(
    pgs == "pgs_reg2" ~ "Middle PGS vs Low",
    pgs == "pgs_reg3" ~ "High PGS vs Low")) %>%
  dplyr::select(Wave, Mediator, Label, `Effect Type` = Effect_Type, `Effect Estimate` = Mean, `CI Low` = CI_Low, `CI High` = CI_High)

results_pgs_clean # all confidence intervals included

results_pgs_all <- plot_ALL_pgs_data %>%
  mutate(`Percent difference` = (TCE - CDM) / TCE * 100) %>%
  dplyr::select(Wave, Mediator, Label = pgs_Label, CDM, TCE, DIF, `CI Low` = CI_Low, `CI High` = CI_High, `Percent difference`)

results_pgs_all # dif confidence intervals and percentage decrease
```

***

# Joint plot 

```{r join plots together}
strip_labels <- function(p) p + 
  labs(title = NULL, subtitle = NULL, caption = NULL, y = NULL, x = "Estimate") +
  scale_shape_manual(
    name = "",
    values = c("CDM" = 16, "TCE" = 17), # Circle for CDM, triangle for TCE
    labels = c("Socially mitigated effect", "Total causal effect"))

clean_legend <- theme(legend.position = "bottom") 

P1 <- strip_labels(plot_sex)      + clean_legend  + geom_vline(xintercept = 0, linetype = "dashed", color = "grey")
P2A <- strip_labels(plot_race_asian)     + clean_legend  + scale_y_discrete(labels = NULL) + geom_vline(xintercept = 0, linetype = "dashed", color = "dark grey")
P2B <- strip_labels(plot_race_black)     + clean_legend  + scale_y_discrete(labels = NULL) + geom_vline(xintercept = 0, linetype = "dashed", color = "dark grey")
P3 <- strip_labels(plot_ses)      + clean_legend
P4 <- strip_labels(plot_pgs_ALL)  + clean_legend  + scale_y_discrete(labels = NULL)

combined_fig <-
  ((P1 + P2A + P2B) / (P3 + P4)) +
  plot_layout(guides = "collect") +
  plot_annotation(
    title = "Social connection and inclusion mitigates the associations between depression and sex, race, SES, and PGS",
    subtitle = paste0("Wave 2 N = ", nrow(dat_pheno_W2), "; Wave 4 N = ", nrow(dat_pheno_W4), 
                      "; Wave 2 PGS N = ", nrow(dat_pheno_pgs_W2), "; Wave 4 PGS N = ", nrow(dat_pheno_pgs_W4), 
                      ";  \nReference group = Male / White people / High SES families / Low PGS",
                      "; 1000 Monte Carlo expansions and 1000 bootstrap confidence intervals"),
    caption = "* indicates a significant reduction in disparity due to social connection"
  ) &
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, size = 28),
    plot.subtitle = element_text(hjust = 0.5, face = "italic", size = 23),
    plot.caption = element_text(size = 20),
    axis.text = element_text(size = 20),
    axis.text.y = element_text(size = 25),
    strip.text = element_text(face = "bold", size = 23),
    legend.text = element_text(size = 28)
  )

save_gg_cairo(combined_fig, "/home/thom1336/healthdis/figures/results_combined disparity.png", 
              width = 2000, height = 1450)
```

# Joint tables

```{r supplement CI table}
results_clean <- rbind(results_sex_clean, results_race_clean, results_ses_clean, results_pgs_clean) %>%
  mutate(Significant = if_else(`CI Low` > 0 | `CI High` < 0, "Yes", "No")) %>%
  mutate(across(where(is.numeric), ~ round(., 3)))
```

```{r for main text paper}
label_order <- c(
  "Female vs Male",
  "Black vs White", "Asian vs White",
  "Low SES vs High SES",
  "High PGS vs Low PGS"
)

table_paper <- results_clean %>%
  dplyr::filter(Label != "Native American vs White") %>%
  mutate(
    star     = if_else(Significant == "Yes", "*", ""),
    est_ci   = sprintf("%.3f (%.3f–%.3f)%s",
                       `Effect Estimate`, `CI Low`, `CI High`, star),
    Mediator = str_to_sentence(Mediator),
    Label    = factor(Label, levels = unique(c(label_order, Label)))
  ) %>%
  dplyr::select(Wave, Label, Mediator, `Effect Type`, est_ci) %>%
  distinct() %>%
  # ensure one value per (Wave, Label, Mediator, Effect Type)
  group_by(Wave, Label, Mediator, `Effect Type`) %>%
  summarise(est_ci = first(est_ci), .groups = "drop") %>%
  pivot_wider(
    names_from  = `Effect Type`,
    values_from = est_ci
  ) %>%
  rename(Comparison = Label, `Mediated Effect` = CDM, Difference = DIF, `Total Causal Effect` = TCE) %>%
  dplyr::select(Wave, Comparison, Mediator, `Total Causal Effect`, `Mediated Effect`, Difference) 

table_paper
```


```{r difference results}
results_diff <- rbind(results_sex_all, results_race_all, results_ses_all, results_pgs_all) %>%
  mutate(across(where(is.numeric), ~ round(., 3))) %>%
  mutate(Mediator = str_to_sentence(Mediator)) %>%
  rename(Comparison = Label)

results <- left_join(table_paper, results_diff, by = c("Wave", "Mediator", "Comparison")) %>%
  dplyr::select(-CDM, -TCE, -DIF, -`CI Low`, -`CI High`) %>%
  rename(`Percent difference decrease` = `Percent difference`)
```


